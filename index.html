<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Anggaran Kolaboratif (Firebase)</title>
    <!-- Memuat Tailwind CSS untuk styling modern -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Font Inter dari Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none; margin: 0;
        }
        input[type=number] { -moz-appearance: textfield; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-slate-900 text-white flex items-center justify-center min-h-screen p-4">

    <!-- Layar Login / Pilih User -->
    <div id="login-screen" class="w-full max-w-sm">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl">
            <h2 class="text-3xl font-bold text-center text-cyan-400 mb-6">Masuk / Pilih User</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="username" class="block text-slate-300 mb-1">Username</label>
                    <input type="text" id="username" placeholder="Masukkan nama Anda" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-cyan-500 transition">
                </div>
                <p id="login-error" class="text-red-400 text-sm hidden">Username tidak boleh kosong.</p>
                <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 font-semibold rounded-lg p-3 transition-colors !mt-6">Masuk sebagai Kolaborator</button>
            </form>
        </div>
    </div>

    <!-- Kontainer Aplikasi Utama (Hidden by default) -->
    <div id="app-container" class="w-full max-w-7xl hidden">
        <div class="bg-slate-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-8">
            <header class="text-center">
                <h1 class="text-3xl md:text-4xl font-bold text-cyan-400">Kalkulator Anggaran Kolaboratif</h1>
                <p class="text-slate-400 mt-2">Anda masuk sebagai: <span id="current-user-display" class="font-bold"></span></p>
                 <div class="mt-4 flex justify-center gap-4">
                    <button id="history-btn" class="bg-indigo-600 hover:bg-indigo-700 font-semibold rounded-lg px-4 py-2 transition-colors text-sm">Lihat Histori Perubahan</button>
                    <button id="logout-btn" class="bg-red-600 hover:bg-red-700 font-semibold rounded-lg px-4 py-2 transition-colors text-sm">Keluar</button>
                </div>
            </header>

            <!-- Area Input -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                 <!-- Form Input digabung untuk semua jenis -->
                <div class="md:col-span-2 lg:col-span-3 space-y-4 bg-slate-900/50 p-6 rounded-xl">
                    <h2 class="text-2xl font-bold text-white text-center">Tambah Transaksi Baru</h2>
                    <form id="main-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div class="md:col-span-3">
                            <label for="form-type" class="block text-sm font-medium text-slate-300 mb-1">Tipe Transaksi</label>
                            <select id="form-type" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                                <option value="expense">Pengeluaran</option>
                                <option value="income">Pendapatan</option>
                                <option value="savings">Tabungan</option>
                                <option value="debt">Hutang</option>
                                <option value="receivable">Piutang</option>
                            </select>
                        </div>
                        <div>
                            <label for="form-name" class="block text-sm font-medium text-slate-300 mb-1">Nama</label>
                            <input id="form-name" type="text" list="name-suggestions" placeholder="Nama Transaksi" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                            <datalist id="name-suggestions"></datalist>
                        </div>
                        <div>
                            <label for="form-amount" class="block text-sm font-medium text-slate-300 mb-1">Jumlah (Rp)</label>
                            <input id="form-amount" type="number" placeholder="Jumlah" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        </div>
                        <div id="form-category-container">
                             <label for="form-category" class="block text-sm font-medium text-slate-300 mb-1">Kategori</label>
                             <select id="form-category" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                                <!-- Options will be populated by JS -->
                             </select>
                        </div>
                        <div class="md:col-span-3">
                            <button type="submit" id="form-submit-btn" class="w-full bg-cyan-500 hover:bg-cyan-600 font-semibold rounded-lg px-4 py-2 transition-colors">Tambah Pengeluaran</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Bagian Filter dan Catatan -->
            <div class="bg-slate-900/50 p-6 rounded-xl space-y-4">
                <h2 class="text-2xl font-bold text-white text-center">Riwayat Transaksi Bersama</h2>
                 <!-- Filter -->
                <div id="filter-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end border-b border-slate-700 pb-4">
                    <div>
                        <label for="filter-type" class="block text-sm font-medium text-slate-300 mb-1">Filter Tipe</label>
                        <select id="filter-type" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                             <option value="semua">Semua Tipe</option>
                            <option value="income">Pendapatan</option>
                            <option value="expense">Pengeluaran</option>
                            <option value="savings">Tabungan</option>
                            <option value="debt">Hutang</option>
                            <option value="receivable">Piutang</option>
                        </select>
                    </div>
                     <div>
                        <label for="filter-name" class="block text-sm font-medium text-slate-300 mb-1">Cari Nama</label>
                        <input type="text" id="filter-name" placeholder="cth: Listrik" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                    </div>
                    <div class="col-span-1 sm:col-span-2 lg:col-span-2 flex gap-2">
                        <button id="apply-filter-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 font-semibold rounded-lg px-4 py-2 transition-colors">Terapkan Filter</button>
                        <button id="reset-filter-btn" class="w-full bg-slate-600 hover:bg-slate-700 font-semibold rounded-lg px-4 py-2 transition-colors">Reset</button>
                    </div>
                </div>
                <div id="all-records-list" class="space-y-2 max-h-96 overflow-y-auto pr-2 custom-scrollbar">
                    <p class="text-center text-slate-400 py-8">Memuat data dari server...</p>
                </div>
            </div>

            <!-- Ringkasan Anggaran Keseluruhan -->
            <footer class="bg-slate-900/70 p-6 rounded-xl mt-6">
                <h3 class="text-2xl font-bold text-center text-cyan-300 mb-4">Ringkasan Keuangan Total</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-center">
                    <div><p class="text-slate-400 text-sm">Total Pendapatan</p><p id="total-income" class="text-xl font-semibold text-cyan-400">Rp 0</p></div>
                    <div><p class="text-slate-400 text-sm">Total Pengeluaran</p><p id="total-expenses" class="text-xl font-semibold text-red-400">Rp 0</p></div>
                    <div><p class="text-slate-400 text-sm">Total Tabungan</p><p id="total-savings" class="text-xl font-semibold text-green-400">Rp 0</p></div>
                    <div><p class="text-slate-400 text-sm">Hutang Aktif</p><p id="total-debts" class="text-xl font-semibold text-yellow-400">Rp 0</p></div>
                    <div><p class="text-slate-400 text-sm">Piutang Aktif</p><p id="total-receivables" class="text-xl font-semibold text-blue-400">Rp 0</p></div>
                    <div><p class="text-slate-400 text-sm font-bold">Sisa Uang</p><p id="remaining-balance" class="text-xl font-bold text-white">Rp 0</p></div>
                </div>
            </footer>
        </div>
    </div>
    
    <!-- Modal Edit Transaksi -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-md space-y-4">
            <h3 class="text-2xl font-bold text-white">Edit Catatan</h3>
            <form id="edit-form" class="space-y-4">
                <div>
                    <label for="edit-name" class="block text-sm font-medium text-slate-300 mb-1">Nama</label>
                    <input type="text" id="edit-name" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                </div>
                <div>
                    <label for="edit-amount" class="block text-sm font-medium text-slate-300 mb-1">Jumlah</label>
                    <input type="number" id="edit-amount" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="cancel-edit-btn" class="bg-slate-600 hover:bg-slate-700 font-semibold rounded-lg px-4 py-2 transition-colors">Batal</button>
                    <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 font-semibold rounded-lg px-4 py-2 transition-colors">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Histori -->
    <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-2xl space-y-4">
            <div class="flex justify-between items-center">
                <h3 class="text-2xl font-bold text-white">Histori Perubahan</h3>
                <button id="close-history-btn" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="audit-log-content" class="max-h-[60vh] overflow-y-auto custom-scrollbar p-1"></div>
        </div>
    </div>
    
    <!-- Custom Alert Modal -->
    <div id="custom-alert-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-sm space-y-4 text-center">
            <h3 class="text-xl font-bold text-white">Peringatan</h3>
            <p id="custom-alert-message" class="text-slate-300"></p>
            <button id="custom-alert-ok-btn" class="bg-cyan-500 hover:bg-cyan-600 font-semibold rounded-lg px-6 py-2 transition-colors">OK</button>
        </div>
    </div>


    <!-- FIREBASE SCRIPT -->
    <script type="module">
        // Import fungsi yang dibutuhkan dari Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, getDoc, setDoc, deleteDoc, updateDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Konfigurasi Firebase Anda
        const firebaseConfig = {
            apiKey: "AIzaSyCUOfdSPWN4avQsox-0RyxGWwS-c2oRLRo",
            authDomain: "test-f0749.firebaseapp.com",
            projectId: "test-f0749",
            storageBucket: "test-f0749.appspot.com",
            messagingSenderId: "777827353315",
            appId: "1:777827353315:web:b2647a210011f374ec3bd6"
        };

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Referensi Koleksi Firestore
        const transactionsCol = collection(db, "transactions");
        const auditLogCol = collection(db, "auditLog");

        // --- STATE APLIKASI ---
        let currentUser = null;
        let allRecords = [];
        let editingRecordId = null;

        // --- SELEKSI ELEMEN DOM ---
        const getEl = id => document.getElementById(id);
        const loginScreen = getEl('login-screen');
        const appContainer = getEl('app-container');
        const loginForm = getEl('login-form');
        const usernameInput = getEl('username');
        const currentUserDisplay = getEl('current-user-display');
        const logoutBtn = getEl('logout-btn');
        const mainForm = getEl('main-form');
        const allRecordsList = getEl('all-records-list');
        const summaryElements = {
            totalIncome: getEl('total-income'), totalExpenses: getEl('total-expenses'), totalSavings: getEl('total-savings'), totalDebts: getEl('total-debts'), totalReceivables: getEl('total-receivables'), remainingBalance: getEl('remaining-balance')
        };
        const editModal = getEl('edit-modal');
        const editForm = getEl('edit-form');
        const cancelEditBtn = getEl('cancel-edit-btn');
        const historyBtn = getEl('history-btn');
        const historyModal = getEl('history-modal');
        const closeHistoryBtn = getEl('close-history-btn');
        const auditLogContent = getEl('audit-log-content');
        const customAlertModal = getEl('custom-alert-modal');
        const customAlertMessage = getEl('custom-alert-message');
        const customAlertOkBtn = getEl('custom-alert-ok-btn');
        const filterControls = {
            type: getEl('filter-type'), name: getEl('filter-name'), applyBtn: getEl('apply-filter-btn'), resetBtn: getEl('reset-filter-btn')
        };
        
        // --- FORM ELEMENTS ---
        const formTypeSelect = getEl('form-type');
        const formNameInput = getEl('form-name');
        const formAmountInput = getEl('form-amount');
        const formCategoryContainer = getEl('form-category-container');
        const formCategorySelect = getEl('form-category');
        const formSubmitBtn = getEl('form-submit-btn');

        // --- SVG ICONS ---
        const trashIconSVG = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>`;
        const checkIconSVG = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>`;
        const editIconSVG = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg>`;
        const userIconSVG = `<svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>`;

        // --- FUNGSI ---
        const formatRupiah = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
        const formatTimestamp = (ts) => ts ? ts.toDate().toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }) : 'Baru saja';
        const showAlert = (message) => {
            customAlertMessage.textContent = message;
            customAlertModal.classList.remove('hidden');
        };
        customAlertOkBtn.addEventListener('click', () => customAlertModal.classList.add('hidden'));

        async function logAction(action, details) {
            if (!currentUser) return;
            try {
                await addDoc(auditLogCol, {
                    user: currentUser,
                    action,
                    details,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error("Gagal mencatat log: ", error);
            }
        }
        
        function renderAll(records) {
            renderRecords(records);
            updateOverallSummary(records);
        }

        function renderRecords(recordsToRender) {
            allRecordsList.innerHTML = '';
            if (recordsToRender.length === 0) {
                allRecordsList.innerHTML = `<p class="text-slate-500 text-center py-8 italic">Tidak ada catatan transaksi.</p>`;
                return;
            }
            recordsToRender.forEach(item => {
                const itemDiv = createListItem(item);
                allRecordsList.appendChild(itemDiv);
            });
        }

        function createListItem(item) {
            const { id, type, name, amount, category, timestamp, user, isPaid = false } = item;
            const itemDiv = document.createElement('div');
            const typeConfig = {
                income: { color: 'text-cyan-300', border: 'border-cyan-500', label: 'Pendapatan' },
                expense: { color: 'text-red-300', border: 'border-red-500', label: 'Pengeluaran' },
                savings: { color: 'text-green-300', border: 'border-green-500', label: 'Tabungan' },
                debt: { color: 'text-yellow-300', border: 'border-yellow-500', label: 'Hutang' },
                receivable: { color: 'text-blue-300', border: 'border-blue-500', label: 'Piutang' }
            };
            const config = typeConfig[type];

            let actionButtons = `
                <button data-id="${id}" class="edit-btn text-slate-400 hover:text-white transition-colors mr-2">${editIconSVG}</button>
                <button data-id="${id}" class="delete-btn text-slate-400 hover:text-white transition-colors">${trashIconSVG}</button>`;
            
            if (type === 'debt' || type === 'receivable') {
                actionButtons = `<button data-id="${id}" class="toggle-paid-btn text-slate-400 ${isPaid ? 'text-green-400' : 'hover:text-green-400'} transition-colors mr-2">${checkIconSVG}</button>` + actionButtons;
            }

            const categoryHTML = category ? `<span class="text-xs bg-slate-600/50 text-slate-300 px-2 py-1 rounded-full">${category}</span>` : `<span class="text-xs bg-slate-600/50 text-slate-400 px-2 py-1 rounded-full">${config.label}</span>`;

            itemDiv.className = `bg-slate-700/50 p-3 rounded-lg flex justify-between items-center transition-opacity border-l-4 ${config.border} ${isPaid ? 'opacity-50' : ''}`;
            itemDiv.innerHTML = `
                <div class="flex-grow mr-2">
                    <p class="font-medium text-white ${isPaid ? 'line-through' : ''}">${name}</p>
                    <div class="flex items-center text-xs text-slate-400 mt-1.5 gap-x-2">
                        ${categoryHTML}
                        <div class="flex items-center">${userIconSVG} <span>${user || 'Anonim'}</span></div>
                    </div>
                </div>
                <div class="flex items-center">
                    <span class="font-semibold text-right ${config.color} mr-4 ${isPaid ? 'line-through' : ''}">${formatRupiah(amount)}<br><span class="text-xs font-normal text-slate-500">${formatTimestamp(timestamp)}</span></span>
                    <div class="flex items-center">${actionButtons}</div>
                </div>`;
            return itemDiv;
        }

        function updateOverallSummary(records) {
            const totalIncome = records.filter(r => r.type === 'income').reduce((sum, item) => sum + item.amount, 0);
            const totalExpenses = records.filter(r => r.type === 'expense').reduce((sum, item) => sum + item.amount, 0);
            const totalSavings = records.filter(r => r.type === 'savings').reduce((sum, item) => sum + item.amount, 0);
            const totalDebts = records.filter(r => r.type === 'debt' && !r.isPaid).reduce((sum, item) => sum + item.amount, 0);
            const totalReceivables = records.filter(r => r.type === 'receivable' && !r.isPaid).reduce((sum, item) => sum + item.amount, 0);
            const remainingBalance = totalIncome - totalExpenses - totalSavings;

            summaryElements.totalIncome.textContent = formatRupiah(totalIncome);
            summaryElements.totalExpenses.textContent = formatRupiah(totalExpenses);
            summaryElements.totalSavings.textContent = formatRupiah(totalSavings);
            summaryElements.totalDebts.textContent = formatRupiah(totalDebts);
            summaryElements.totalReceivables.textContent = formatRupiah(totalReceivables);
            summaryElements.remainingBalance.textContent = formatRupiah(remainingBalance);
        }
        
        function updateFormUI() {
            const type = formTypeSelect.value;
            const config = {
                income: { cat: ['Gaji', 'Transfer Masuk', 'Bonus', 'Hasil Usaha', 'Lainnya'], btn: 'Tambah Pendapatan', color: 'cyan' },
                expense: { cat: ['Rumah', 'Tagihan', 'Jajan', 'Kendaraan', 'Transfer', 'Belanja', 'Kesehatan', 'Hiburan', 'Pendidikan', 'Lainnya'], btn: 'Tambah Pengeluaran', color: 'red' },
                savings: { cat: null, btn: 'Tambah Tabungan', color: 'green' },
                debt: { cat: null, btn: 'Tambah Hutang', color: 'yellow' },
                receivable: { cat: null, btn: 'Tambah Piutang', color: 'blue' }
            };
            
            const currentConfig = config[type];
            formSubmitBtn.textContent = currentConfig.btn;
            formSubmitBtn.className = `w-full bg-${currentConfig.color}-500 hover:bg-${currentConfig.color}-600 font-semibold rounded-lg px-4 py-2 transition-colors`;
            
            if (currentConfig.cat) {
                formCategoryContainer.classList.remove('hidden');
                formCategorySelect.innerHTML = currentConfig.cat.map(c => `<option value="${c}">${c}</option>`).join('');
            } else {
                formCategoryContainer.classList.add('hidden');
            }
        }
        
        // --- EVENT LISTENERS ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = usernameInput.value.trim();
            if (username) {
                currentUser = username;
                sessionStorage.setItem('budgetUser', currentUser);
                loginScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                currentUserDisplay.textContent = currentUser;
                logAction("User Masuk", `User '${currentUser}' telah bergabung.`);
            } else {
                showAlert('Username tidak boleh kosong.');
            }
        });
        
        logoutBtn.addEventListener('click', () => {
            logAction("User Keluar", `User '${currentUser}' telah keluar.`);
            currentUser = null;
            sessionStorage.removeItem('budgetUser');
            loginForm.reset();
            appContainer.classList.add('hidden');
            loginScreen.classList.remove('hidden');
        });
        
        formTypeSelect.addEventListener('change', updateFormUI);

        mainForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = formNameInput.value.trim();
            const amount = parseFloat(formAmountInput.value);

            if (!name || isNaN(amount) || amount <= 0) {
                showAlert("Nama dan Jumlah (harus angka positif) wajib diisi.");
                return;
            }

            const newRecord = {
                type: formTypeSelect.value,
                name,
                amount,
                user: currentUser,
                timestamp: serverTimestamp(),
                isPaid: false,
            };
            
            if(!formCategoryContainer.classList.contains('hidden')){
                newRecord.category = formCategorySelect.value;
            }

            try {
                await addDoc(transactionsCol, newRecord);
                await logAction(`Tambah ${newRecord.type}`, `${name} - ${formatRupiah(amount)}`);
                mainForm.reset();
                updateFormUI(); // Reset form UI to default
            } catch (error) {
                console.error("Gagal menambah data:", error);
                showAlert("Gagal menyimpan data ke server.");
            }
        });

        allRecordsList.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const id = button.dataset.id;
            const recordRef = doc(db, "transactions", id);

            if (button.classList.contains('delete-btn')) {
                if (confirm('Anda yakin ingin menghapus transaksi ini?')) {
                    try {
                        const recordToDelete = allRecords.find(r => r.id === id);
                        await deleteDoc(recordRef);
                        await logAction(`Hapus ${recordToDelete.type}`, `${recordToDelete.name} - ${formatRupiah(recordToDelete.amount)}`);
                    } catch (error) { console.error("Error menghapus:", error); }
                }
            } else if (button.classList.contains('toggle-paid-btn')) {
                 const recordToUpdate = allRecords.find(r => r.id === id);
                 const newPaidStatus = !recordToUpdate.isPaid;
                 try {
                    await updateDoc(recordRef, { isPaid: newPaidStatus });
                    const status = newPaidStatus ? 'Lunas' : 'Belum Lunas';
                    await logAction(`Ubah Status ${recordToUpdate.type}`, `${recordToUpdate.name} menjadi ${status}`);
                 } catch (error) { console.error("Error update status:", error); }
            } else if (button.classList.contains('edit-btn')) {
                const recordToEdit = allRecords.find(r => r.id === id);
                editingRecordId = id;
                getEl('edit-name').value = recordToEdit.name;
                getEl('edit-amount').value = recordToEdit.amount;
                editModal.classList.remove('hidden');
            }
        });
        
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!editingRecordId) return;
            
            const recordRef = doc(db, 'transactions', editingRecordId);
            const newName = getEl('edit-name').value.trim();
            const newAmount = parseFloat(getEl('edit-amount').value);
            
            if(!newName || isNaN(newAmount) || newAmount <= 0) {
                 showAlert("Nama dan Jumlah (harus angka positif) wajib diisi.");
                return;
            }
            
            try {
                await updateDoc(recordRef, { name: newName, amount: newAmount });
                await logAction(`Edit Transaksi`, `ID ${editingRecordId} diubah menjadi ${newName} - ${formatRupiah(newAmount)}`);
                editModal.classList.add('hidden');
                editingRecordId = null;
            } catch (error) { console.error("Gagal edit:", error); }
        });

        cancelEditBtn.addEventListener('click', () => editModal.classList.add('hidden'));
        
        filterControls.applyBtn.addEventListener('click', () => {
             const typeFilter = filterControls.type.value;
             const nameFilter = filterControls.name.value.toLowerCase().trim();
             
             let filteredRecords = allRecords;
             if(typeFilter !== 'semua') {
                 filteredRecords = filteredRecords.filter(r => r.type === typeFilter);
             }
             if(nameFilter) {
                 filteredRecords = filteredRecords.filter(r => r.name.toLowerCase().includes(nameFilter));
             }
             renderRecords(filteredRecords);
        });
        
        filterControls.resetBtn.addEventListener('click', () => {
            filterControls.type.value = 'semua';
            filterControls.name.value = '';
            renderRecords(allRecords);
        });

        historyBtn.addEventListener('click', () => historyModal.classList.remove('hidden'));
        closeHistoryBtn.addEventListener('click', () => historyModal.classList.add('hidden'));

        // --- REAL-TIME LISTENERS ---
        onSnapshot(query(transactionsCol, orderBy("timestamp", "desc")), (snapshot) => {
            allRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAll(allRecords);
            filterControls.resetBtn.click(); // Reset filter saat data baru masuk
        });
        
        onSnapshot(query(auditLogCol, orderBy("timestamp", "desc")), (snapshot) => {
            auditLogContent.innerHTML = '';
            snapshot.docs.forEach(doc => {
                 const log = doc.data();
                 const logEl = document.createElement('div');
                 logEl.className = 'text-sm text-slate-300 p-2 border-b border-slate-700';
                 logEl.innerHTML = `<span class="font-semibold text-cyan-400">${log.user}</span>: ${log.action} <span class="text-slate-400">(${log.details})</span> - <span class="text-xs">${formatTimestamp(log.timestamp)}</span>`;
                 auditLogContent.appendChild(logEl);
            });
        });

        // --- INISIALISASI ---
        currentUser = sessionStorage.getItem('budgetUser');
        if (currentUser) {
            loginScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');
            currentUserDisplay.textContent = currentUser;
        }
        updateFormUI();

    </script>
</body>
</html>
