<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Anggaran Kolaboratif (Firebase)</title>
    <!-- Memuat Tailwind CSS untuk styling modern -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Font Inter dari Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Menambahkan Tone.js untuk notifikasi suara -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none; margin: 0;
        }
        input[type=number] { -moz-appearance: textfield; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .hidden { display: none; }
        .fab-menu-item {
            transition: all 0.3s ease;
        }
        /* Style untuk tombol kalkulator saat ditekan dari keyboard */
        .key-pressed {
            transform: scale(0.95);
            filter: brightness(1.2);
        }
    </style>
</head>
<body class="bg-slate-900 text-white flex items-center justify-center min-h-screen p-4">

    <!-- Layar Login / Pilih User -->
    <div id="login-screen" class="w-full max-w-sm">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl">
            <h2 class="text-3xl font-bold text-center text-cyan-400 mb-6">AnD</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="username" class="block text-slate-300 mb-1">Username</label>
                    <select id="username" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-cyan-500 transition">
                        <option value="andre">andre</option>
                        <option value="dila">dila</option>
                    </select>
                </div>
                 <div>
                    <label for="password" class="block text-slate-300 mb-1">Password</label>
                    <input type="password" id="password" placeholder="Masukkan password Anda" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-cyan-500 transition">
                </div>
                <p id="login-error" class="text-red-400 text-sm hidden">Username atau password salah.</p>
                <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 font-semibold rounded-lg p-3 transition-colors !mt-6">Masuk</button>
            </form>
        </div>
    </div>

    <!-- Kontainer Aplikasi Utama (Hidden by default) -->
    <div id="app-container" class="w-full max-w-7xl hidden">
        <div class="bg-slate-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-8">
            <header class="text-center">
                <h1 class="text-3xl md:text-4xl font-bold text-cyan-400">AnD</h1>
                <p class="text-slate-400 mt-2">Anda masuk sebagai: <span id="current-user-display" class="font-bold"></span></p>
                 <div class="mt-4 flex justify-center gap-4">
                    <button id="manage-names-btn" class="bg-gray-600 hover:bg-gray-700 font-semibold rounded-lg px-4 py-2 transition-colors text-sm">Kelola Nama</button>
                    <button id="history-btn" class="bg-indigo-600 hover:bg-indigo-700 font-semibold rounded-lg px-4 py-2 transition-colors text-sm">Lihat Histori Perubahan</button>
                    <button id="logout-btn" class="bg-red-600 hover:bg-red-700 font-semibold rounded-lg px-4 py-2 transition-colors text-sm">Keluar</button>
                </div>
            </header>

            <!-- Area Input -->
            <div class="md:col-span-2 lg:col-span-3 space-y-4 bg-slate-900/50 p-6 rounded-xl">
                <h2 class="text-2xl font-bold text-white text-center">Tambah Transaksi Baru</h2>
                <form id="main-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                    <div class="lg:col-span-2">
                        <label for="form-name" class="block text-sm font-medium text-slate-300 mb-1">Nama Transaksi</label>
                        <input id="form-name" type="text" list="name-suggestions" placeholder="cth: Gaji Bulanan, Bayar Listrik" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <datalist id="name-suggestions"></datalist>
                    </div>
                    <div>
                        <label for="form-amount" class="block text-sm font-medium text-slate-300 mb-1">Jumlah (Rp)</label>
                        <input id="form-amount" type="number" placeholder="Jumlah" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                    </div>
                    <div>
                        <label for="form-date" class="block text-sm font-medium text-slate-300 mb-1">Tanggal</label>
                        <input id="form-date" type="date" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-slate-400">
                    </div>
                    <div>
                        <label for="form-type" class="block text-sm font-medium text-slate-300 mb-1">Tipe Transaksi</label>
                        <select id="form-type" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                            <option value="expense">Pengeluaran</option>
                            <option value="income">Pendapatan</option>
                            <option value="savings">Tabungan</option>
                            <option value="debt">Hutang</option>
                            <option value="receivable">Piutang</option>
                        </select>
                    </div>
                    <div id="form-category-container">
                         <label for="form-category" class="block text-sm font-medium text-slate-300 mb-1">Kategori</label>
                         <select id="form-category" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                            <!-- Options will be populated by JS -->
                         </select>
                    </div>
                    <div class="lg:col-span-2">
                        <label for="form-note" class="block text-sm font-medium text-slate-300 mb-1">Catatan (Opsional)</label>
                        <input id="form-note" type="text" placeholder="Detail tambahan transaksi" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                    </div>
                    <div class="lg:col-span-4">
                        <button type="submit" id="form-submit-btn" class="w-full bg-cyan-500 hover:bg-cyan-600 font-semibold rounded-lg px-4 py-2 transition-colors mt-2">Tambah Pengeluaran</button>
                    </div>
                </form>
            </div>

            <!-- Bagian Filter dan Catatan -->
            <div class="bg-slate-900/50 p-6 rounded-xl space-y-4">
                <h2 class="text-2xl font-bold text-white text-center">Riwayat Transaksi Bersama</h2>
                 <!-- Filter -->
                <div id="filter-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 items-end border-b border-slate-700 pb-4">
                    <div>
                        <label for="filter-type" class="block text-sm font-medium text-slate-300 mb-1">Filter Tipe</label>
                        <select id="filter-type" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                            <option value="semua">Semua Tipe</option>
                            <option value="income">Pendapatan</option>
                            <option value="expense">Pengeluaran</option>
                            <option value="savings">Tabungan</option>
                            <option value="debt">Hutang</option>
                            <option value="receivable">Piutang</option>
                        </select>
                    </div>
                    <div>
                        <label for="filter-name" class="block text-sm font-medium text-slate-300 mb-1">Cari Nama</label>
                        <input type="text" id="filter-name" placeholder="cth: Listrik" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                    </div>
                     <div>
                        <label for="filter-start-date" class="block text-sm font-medium text-slate-300 mb-1">Dari Tanggal</label>
                        <input type="date" id="filter-start-date" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-slate-400">
                    </div>
                    <div>
                        <label for="filter-end-date" class="block text-sm font-medium text-slate-300 mb-1">Sampai Tanggal</label>
                        <input type="date" id="filter-end-date" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-slate-400">
                    </div>
                    <div class="flex gap-2">
                        <button id="apply-filter-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 font-semibold rounded-lg px-4 py-2 transition-colors">Filter</button>
                        <button id="reset-filter-btn" class="w-full bg-slate-600 hover:bg-slate-700 font-semibold rounded-lg px-4 py-2 transition-colors">Reset</button>
                    </div>
                </div>
                
                <div id="filtered-summary-container" class="text-center pt-4 hidden">
                    <p class="text-lg text-slate-300">Total Arus Kas Hasil Filter: 
                        <span id="filtered-total" class="font-bold"></span>
                    </p>
                </div>

                <div id="all-records-list" class="space-y-2 max-h-96 overflow-y-auto pr-2 custom-scrollbar">
                    <p class="text-center text-slate-400 py-8">Memuat data dari server...</p>
                </div>
            </div>

            <!-- Ringkasan Anggaran Keseluruhan -->
            <footer class="bg-slate-900/70 p-6 rounded-xl mt-6">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                     <h3 class="text-2xl font-bold text-center sm:text-left text-cyan-300">Ringkasan Keuangan</h3>
                     <div class="flex items-center gap-2">
                        <select id="summary-month-filter" class="bg-slate-700 border border-slate-600 rounded-lg p-2 text-sm">
                            <option value="-1">Semua Bulan</option>
                            <option value="0">Januari</option>
                            <option value="1">Februari</option>
                            <option value="2">Maret</option>
                            <option value="3">April</option>
                            <option value="4">Mei</option>
                            <option value="5">Juni</option>
                            <option value="6">Juli</option>
                            <option value="7">Agustus</option>
                            <option value="8">September</option>
                            <option value="9">Oktober</option>
                            <option value="10">November</option>
                            <option value="11">Desember</option>
                        </select>
                        <select id="summary-year-filter" class="bg-slate-700 border border-slate-600 rounded-lg p-2 text-sm">
                           <!-- Opsi tahun akan ditambahkan oleh JS -->
                        </select>
                     </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-center">
                    <div><p class="text-slate-400 text-sm">Total Pendapatan</p><p id="total-income" class="text-xl font-semibold text-cyan-400">Rp 0</p></div>
                    <div><p class="text-slate-400 text-sm">Total Pengeluaran</p><p id="total-expenses" class="text-xl font-semibold text-red-400">Rp 0</p></div>
                    <div><p class="text-slate-400 text-sm">Total Tabungan</p><p id="total-savings" class="text-xl font-semibold text-green-400">Rp 0</p></div>
                    <div><p class="text-slate-400 text-sm">Hutang Aktif</p><p id="total-debts" class="text-xl font-semibold text-yellow-400">Rp 0</p></div>
                    <div><p class="text-slate-400 text-sm">Piutang Aktif</p><p id="total-receivables" class="text-xl font-semibold text-blue-400">Rp 0</p></div>
                    <div><p class="text-slate-400 text-sm font-bold">Sisa Uang</p><p id="remaining-balance" class="text-xl font-bold text-white">Rp 0</p></div>
                </div>
            </footer>
        </div>
    </div>

    <div id="fab-container" class="fixed bottom-6 right-6 z-40">
        <div id="fab-menu" class="flex flex-col items-center mb-2 space-y-2 hidden">
            <button id="chat-btn" class="relative fab-menu-item w-40 bg-teal-600 text-white rounded-lg px-4 py-2 text-sm font-semibold shadow-lg hover:bg-teal-700 transition-transform transform hover:scale-105">
                Chat
                <span id="chat-notification-dot" class="absolute -top-1 -right-1 block w-3 h-3 bg-red-500 rounded-full hidden"></span>
            </button>
            <button id="calculator-btn" class="fab-menu-item w-40 bg-indigo-600 text-white rounded-lg px-4 py-2 text-sm font-semibold shadow-lg hover:bg-indigo-700 transition-transform transform hover:scale-105">Kalkulator</button>
        </div>
        <button id="fab-main-btn" class="w-14 h-14 bg-cyan-500 rounded-full flex items-center justify-center text-white shadow-lg hover:bg-cyan-600 transition-transform transform hover:rotate-45">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
        </button>
    </div>

    <!-- All Modals -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-md space-y-4">
            <h3 class="text-2xl font-bold text-white">Edit Catatan</h3>
            <form id="edit-form" class="space-y-4">
                 <div>
                    <label for="edit-name" class="block text-sm font-medium text-slate-300 mb-1">Nama</label>
                    <input type="text" id="edit-name" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                </div>
                <div>
                    <label for="edit-amount" class="block text-sm font-medium text-slate-300 mb-1">Jumlah</label>
                    <input type="number" id="edit-amount" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                </div>
                <div>
                    <label for="edit-date" class="block text-sm font-medium text-slate-300 mb-1">Tanggal</label>
                    <input type="date" id="edit-date" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-slate-400">
                </div>
                 <div>
                    <label for="edit-note" class="block text-sm font-medium text-slate-300 mb-1">Catatan</label>
                    <input type="text" id="edit-note" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="cancel-edit-btn" class="bg-slate-600 hover:bg-slate-700 font-semibold rounded-lg px-4 py-2 transition-colors">Batal</button>
                    <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 font-semibold rounded-lg px-4 py-2 transition-colors">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>
    <div id="manage-names-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-3xl space-y-4">
            <div class="flex justify-between items-center"><h3 class="text-2xl font-bold text-white">Kelola Nama Transaksi</h3><button id="close-manage-names-btn" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button></div>
            <div id="manage-names-content" class="grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[60vh] overflow-y-auto custom-scrollbar p-2"></div>
        </div>
    </div>
    <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-2xl space-y-4">
            <div class="flex justify-between items-center">
                <h3 class="text-2xl font-bold text-white">Histori Perubahan</h3>
                <button id="close-history-btn" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="audit-log-content" class="max-h-[60vh] overflow-y-auto custom-scrollbar p-1"></div>
        </div>
    </div>
    <div id="calculator-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-xs space-y-4">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold text-white">Kalkulator</h3>
                <button id="close-calculator-btn" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div class="w-full bg-slate-900 text-white rounded-lg p-4 font-mono text-right">
                <div id="calculator-history-display" class="h-6 text-xl text-slate-400 truncate">&nbsp;</div>
                <div id="calculator-display" class="text-4xl">0</div>
            </div>
            <div id="calculator-keys" class="grid grid-cols-4 gap-2 text-xl font-semibold">
                <button class="calculator-key bg-slate-600 hover:bg-slate-500 p-4 rounded-lg transition-transform" data-key="clear" data-action="clear">AC</button>
                <button class="calculator-key bg-slate-600 hover:bg-slate-500 p-4 rounded-lg transition-transform" data-key="Backspace" data-action="backspace">
                    <svg class="w-6 h-6 mx-auto pointer-events-none" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9.75L14.25 12m0 0l2.25 2.25M14.25 12L12 14.25m-2.586-4.5H5.25A2.25 2.25 0 003 12v4.5A2.25 2.25 0 005.25 18.75h9.5A2.25 2.25 0 0017.25 16.5v-4.5A2.25 2.25 0 0014.75 9.75H9.414" />
                    </svg>
                </button>
                <button class="calculator-key bg-slate-600 hover:bg-slate-500 p-4 rounded-lg transition-transform" data-action="sign">+/-</button>
                <button class="calculator-key operator bg-orange-500 hover:bg-orange-600 p-4 rounded-lg transition-transform" data-key="/" data-action="divide">&divide;</button>
                <button class="calculator-key bg-slate-700 hover:bg-slate-600 p-4 rounded-lg transition-transform" data-key="7">7</button>
                <button class="calculator-key bg-slate-700 hover:bg-slate-600 p-4 rounded-lg transition-transform" data-key="8">8</button>
                <button class="calculator-key bg-slate-700 hover:bg-slate-600 p-4 rounded-lg transition-transform" data-key="9">9</button>
                <button class="calculator-key operator bg-orange-500 hover:bg-orange-600 p-4 rounded-lg transition-transform" data-key="*" data-action="multiply">&times;</button>
                <button class="calculator-key bg-slate-700 hover:bg-slate-600 p-4 rounded-lg transition-transform" data-key="4">4</button>
                <button class="calculator-key bg-slate-700 hover:bg-slate-600 p-4 rounded-lg transition-transform" data-key="5">5</button>
                <button class="calculator-key bg-slate-700 hover:bg-slate-600 p-4 rounded-lg transition-transform" data-key="6">6</button>
                <button class="calculator-key operator bg-orange-500 hover:bg-orange-600 p-4 rounded-lg transition-transform" data-key="-" data-action="subtract">-</button>
                <button class="calculator-key bg-slate-700 hover:bg-slate-600 p-4 rounded-lg transition-transform" data-key="1">1</button>
                <button class="calculator-key bg-slate-700 hover:bg-slate-600 p-4 rounded-lg transition-transform" data-key="2">2</button>
                <button class="calculator-key bg-slate-700 hover:bg-slate-600 p-4 rounded-lg transition-transform" data-key="3">3</button>
                <button class="calculator-key operator bg-orange-500 hover:bg-orange-600 p-4 rounded-lg transition-transform" data-key="+" data-action="add">+</button>
                <button class="calculator-key col-span-2 bg-slate-700 hover:bg-slate-600 p-4 rounded-lg transition-transform" data-key="0">0</button>
                <button class="calculator-key bg-slate-700 hover:bg-slate-600 p-4 rounded-lg transition-transform" data-key="." data-action="decimal">,</button>
                <button class="calculator-key operator bg-orange-500 hover:bg-orange-600 p-4 rounded-lg transition-transform" data-key="=" data-action="calculate">=</button>
            </div>
        </div>
    </div>
    <div id="chat-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-slate-800 rounded-xl shadow-2xl w-full max-w-lg h-[80vh] flex flex-col">
            <div class="flex-shrink-0 p-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white">Obrolan Tim</h3>
                <button id="close-chat-btn" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="chat-messages-area" class="flex-grow p-4 space-y-4 overflow-y-auto custom-scrollbar">
                <!-- Pesan chat akan muncul di sini -->
            </div>
            <form id="chat-form" class="flex-shrink-0 p-4 border-t border-slate-700 flex gap-2">
                <input id="chat-input" type="text" placeholder="Ketik pesan..." class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-cyan-500 transition">
                <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 font-semibold rounded-lg px-4 py-2 transition-colors">Kirim</button>
            </form>
        </div>
    </div>
    <div id="custom-alert-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-sm space-y-4 text-center">
            <h3 id="custom-alert-title" class="text-xl font-bold text-white">Peringatan</h3>
            <p id="custom-alert-message" class="text-slate-300"></p>
            <button id="custom-alert-ok-btn" class="bg-cyan-500 hover:bg-cyan-600 font-semibold rounded-lg px-6 py-2 transition-colors">OK</button>
        </div>
    </div>
    <div id="custom-confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-sm space-y-4 text-center">
            <h3 id="custom-confirm-title" class="text-xl font-bold text-white">Konfirmasi</h3>
            <p id="custom-confirm-message" class="text-slate-300"></p>
            <div class="flex justify-center gap-4 pt-4">
                <button id="custom-confirm-cancel-btn" class="bg-slate-600 hover:bg-slate-700 font-semibold rounded-lg px-6 py-2 transition-colors">Batal</button>
                <button id="custom-confirm-ok-btn" class="bg-red-500 hover:bg-red-600 font-semibold rounded-lg px-6 py-2 transition-colors">Ya</button>
            </div>
        </div>
    </div>
    <div id="custom-prompt-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-sm space-y-4">
            <h3 id="custom-prompt-title" class="text-xl font-bold text-white">Input Diperlukan</h3>
            <p id="custom-prompt-message" class="text-slate-300 mb-2"></p>
            <input type="text" id="custom-prompt-input" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
            <div class="flex justify-end gap-4 pt-4">
                <button id="custom-prompt-cancel-btn" class="bg-slate-600 hover:bg-slate-700 font-semibold rounded-lg px-6 py-2 transition-colors">Batal</button>
                <button id="custom-prompt-ok-btn" class="bg-cyan-500 hover:bg-cyan-600 font-semibold rounded-lg px-6 py-2 transition-colors">Simpan</button>
            </div>
        </div>
    </div>

    <!-- FIREBASE SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, deleteDoc, updateDoc, onSnapshot, query, orderBy, serverTimestamp, writeBatch, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Konfigurasi Firebase Anda
        const firebaseConfig = {
            apiKey: "AIzaSyCUOfdSPWN4avQsox-0RyxGWwS-c2oRLRo",
            authDomain: "test-f0749.firebaseapp.com",
            projectId: "test-f0749",
            storageBucket: "test-f0749.appspot.com",
            messagingSenderId: "777827353315",
            appId: "1:777827353315:web:b2647a210011f374ec3bd6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const transactionsCol = collection(db, "transactions");
        const auditLogCol = collection(db, "auditLog");
        const chatCol = collection(db, "chatMessages"); 

        // --- STATE & USERS ---
        let currentUser = null;
        let allRecords = [];
        let editingRecordId = null;
        let isInitialChatLoad = true;
        let isChatOpen = false;
        const USERS = {
            andre: "180125andre",
            dila: "dila180125"
        };

        // --- DOM SELECTION ---
        const getEl = id => document.getElementById(id);
        const loginScreen = getEl('login-screen'), appContainer = getEl('app-container'), loginForm = getEl('login-form'),
              usernameSelect = getEl('username'), passwordInput = getEl('password'), loginError = getEl('login-error'),
              currentUserDisplay = getEl('current-user-display'), logoutBtn = getEl('logout-btn'), mainForm = getEl('main-form'),
              allRecordsList = getEl('all-records-list'), 
              summaryElements = { 
                  totalIncome: getEl('total-income'), 
                  totalExpenses: getEl('total-expenses'), 
                  totalSavings: getEl('total-savings'), 
                  totalDebts: getEl('total-debts'), 
                  totalReceivables: getEl('total-receivables'), 
                  remainingBalance: getEl('remaining-balance'),
                  monthFilter: getEl('summary-month-filter'), 
                  yearFilter: getEl('summary-year-filter')
              },
              formTypeSelect = getEl('form-type'), formNameInput = getEl('form-name'), formAmountInput = getEl('form-amount'),
              formDateInput = getEl('form-date'), formNoteInput = getEl('form-note'), formCategoryContainer = getEl('form-category-container'),
              formCategorySelect = getEl('form-category'), formSubmitBtn = getEl('form-submit-btn'),
              filterControls = { 
                  type: getEl('filter-type'), 
                  name: getEl('filter-name'), 
                  start: getEl('filter-start-date'), 
                  end: getEl('filter-end-date'), 
                  applyBtn: getEl('apply-filter-btn'), 
                  resetBtn: getEl('reset-filter-btn'),
                  summaryContainer: getEl('filtered-summary-container'), 
                  filteredTotal: getEl('filtered-total') 
              },
              historyBtn = getEl('history-btn'), historyModal = getEl('history-modal'), closeHistoryBtn = getEl('close-history-btn'),
              auditLogContent = getEl('audit-log-content'), manageNamesBtn = getEl('manage-names-btn'),
              manageNamesModal = getEl('manage-names-modal'), closeManageNamesBtn = getEl('close-manage-names-btn'), manageNamesContent = getEl('manage-names-content'),
              editModal = getEl('edit-modal'), editForm = getEl('edit-form'), cancelEditBtn = getEl('cancel-edit-btn'),
              fabMainBtn = getEl('fab-main-btn'), fabMenu = getEl('fab-menu'), 
              calculatorBtn = getEl('calculator-btn'), chatBtn = getEl('chat-btn'),
              chatNotificationDot = getEl('chat-notification-dot'),
              calculatorModal = getEl('calculator-modal'), closeCalculatorBtn = getEl('close-calculator-btn'), calculatorDisplay = getEl('calculator-display'),
              calculatorHistoryDisplay = getEl('calculator-history-display'),
              calculatorKeys = getEl('calculator-keys'),
              chatModal = getEl('chat-modal'), closeChatBtn = getEl('close-chat-btn'),
              chatMessagesArea = getEl('chat-messages-area'), chatForm = getEl('chat-form'), chatInput = getEl('chat-input');
              
        // --- SVG ICONS ---
        const trashIconSVG = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>`;
        const checkIconSVG = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>`;
        const editIconSVG = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg>`;
        const userIconSVG = `<svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>`;
        const noteIconSVG = `<svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"></path><path fill-rule="evenodd" d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>`;

        // --- HELPER FUNCTIONS ---
        const formatRupiah = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
        const formatDate = (ts) => ts ? ts.toDate().toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' }) : '-';
        const getTodayString = () => new Date().toISOString().slice(0, 10);
        const toInputDate = (ts) => ts ? new Date(ts.toDate().getTime() - (ts.toDate().getTimezoneOffset() * 60000)).toISOString().split('T')[0] : '';
        async function logAction(action, details) {
            if (!currentUser) return;
            try {
                await addDoc(auditLogCol, { user: currentUser, action, details, timestamp: serverTimestamp() });
            } catch (error) { console.error("Gagal mencatat log: ", error); }
        }

        // --- MODAL FUNCTIONS ---
        const modalElements = {
            alert: { modal: getEl('custom-alert-modal'), title: getEl('custom-alert-title'), message: getEl('custom-alert-message'), okBtn: getEl('custom-alert-ok-btn') },
            confirm: { modal: getEl('custom-confirm-modal'), title: getEl('custom-confirm-title'), message: getEl('custom-confirm-message'), okBtn: getEl('custom-confirm-ok-btn'), cancelBtn: getEl('custom-confirm-cancel-btn') },
            prompt: { modal: getEl('custom-prompt-modal'), title: getEl('custom-prompt-title'), message: getEl('custom-prompt-message'), input: getEl('custom-prompt-input'), okBtn: getEl('custom-prompt-ok-btn'), cancelBtn: getEl('custom-prompt-cancel-btn') }
        };

        const showAlert = (message, title = 'Peringatan') => {
            return new Promise(resolve => {
                modalElements.alert.title.textContent = title;
                modalElements.alert.message.textContent = message;
                modalElements.alert.modal.classList.remove('hidden');
                const handleOk = () => {
                    modalElements.alert.modal.classList.add('hidden');
                    modalElements.alert.okBtn.removeEventListener('click', handleOk);
                    resolve();
                };
                modalElements.alert.okBtn.addEventListener('click', handleOk);
            });
        };

        const showConfirm = (message, title = 'Konfirmasi') => {
            return new Promise(resolve => {
                modalElements.confirm.title.textContent = title;
                modalElements.confirm.message.textContent = message;
                modalElements.confirm.modal.classList.remove('hidden');
                const cleanup = (result) => {
                    modalElements.confirm.modal.classList.add('hidden');
                    modalElements.confirm.okBtn.removeEventListener('click', handleOk);
                    modalElements.confirm.cancelBtn.removeEventListener('click', handleCancel);
                    resolve(result);
                };
                const handleOk = () => cleanup(true);
                const handleCancel = () => cleanup(false);
                modalElements.confirm.okBtn.addEventListener('click', handleOk);
                modalElements.confirm.cancelBtn.addEventListener('click', handleCancel);
            });
        };

        const showPrompt = (message, defaultValue = '', title = 'Input Diperlukan') => {
             return new Promise(resolve => {
                modalElements.prompt.title.textContent = title;
                modalElements.prompt.message.textContent = message;
                modalElements.prompt.input.value = defaultValue;
                modalElements.prompt.modal.classList.remove('hidden');
                modalElements.prompt.input.focus();
                const cleanup = (value) => {
                    modalElements.prompt.modal.classList.add('hidden');
                    modalElements.prompt.okBtn.removeEventListener('click', handleOk);
                    modalElements.prompt.cancelBtn.removeEventListener('click', handleCancel);
                    resolve(value);
                };
                const handleOk = () => cleanup(modalElements.prompt.input.value);
                const handleCancel = () => cleanup(null);
                modalElements.prompt.okBtn.addEventListener('click', handleOk);
                modalElements.prompt.cancelBtn.addEventListener('click', handleCancel);
            });
        };
        
        // --- MAIN RENDER FUNCTIONS ---
        function renderAll(records) {
            renderRecords(records);
            populateDatalist();
            populateSummaryFilters(records);
            handleSummaryFilterChange();
        }

        function renderRecords(recordsToRender) {
            allRecordsList.innerHTML = '';
            if (recordsToRender.length === 0) {
                allRecordsList.innerHTML = `<p class="text-slate-500 text-center py-8 italic">Tidak ada catatan transaksi yang cocok.</p>`;
                return;
            }
            recordsToRender.forEach(item => allRecordsList.appendChild(createListItem(item)));
        }

        function createListItem(item) {
            const { id, type, name, amount, category, date, note, user, isPaid = false } = item;
            const itemDiv = document.createElement('div');
            const typeConfig = {
                income: { color: 'text-cyan-300', border: 'border-cyan-500' },
                expense: { color: 'text-red-300', border: 'border-red-500' },
                savings: { color: 'text-green-300', border: 'border-green-500' },
                debt: { color: 'text-yellow-300', border: 'border-yellow-500' },
                receivable: { color: 'text-blue-300', border: 'border-blue-500' }
            };
            const config = typeConfig[type];

            let actionButtons = `
                <button data-id="${id}" class="edit-btn text-slate-400 hover:text-white transition-colors p-1 rounded-full"><title>Edit</title>${editIconSVG}</button>
                <button data-id="${id}" class="delete-btn text-slate-400 hover:text-white transition-colors p-1 rounded-full"><title>Hapus</title>${trashIconSVG}</button>`;
            if (type === 'debt' || type === 'receivable') {
                actionButtons = `<button data-id="${id}" class="toggle-paid-btn text-slate-400 ${isPaid ? 'text-green-400' : 'hover:text-green-400'} transition-colors p-1 rounded-full"><title>Tandai Lunas</title>${checkIconSVG}</button>` + actionButtons;
            }

            const categoryHTML = category ? `<span class="text-xs bg-slate-600/50 text-slate-300 px-2 py-1 rounded-full">${category}</span>` : '';
            const noteHTML = note ? `<div class="flex items-center text-xs text-slate-400 mt-1.5">${noteIconSVG} <span class="italic">${note}</span></div>` : '';
            
            itemDiv.className = `bg-slate-700/50 p-3 rounded-lg flex justify-between items-center transition-opacity border-l-4 ${config.border} ${isPaid ? 'opacity-50' : ''}`;
            itemDiv.innerHTML = `
                <div class="flex-grow mr-2 space-y-1.5">
                    <p class="font-medium text-white ${isPaid ? 'line-through' : ''}">${name}</p>
                    <div class="flex items-center text-xs text-slate-400 gap-x-3 flex-wrap">
                        <span class="font-semibold">${formatDate(date)}</span>
                        ${categoryHTML ? `<span>|</span> ${categoryHTML}` : ''}
                        <div class="flex items-center">| ${userIconSVG} <span>${user || 'Anonim'}</span></div>
                    </div>
                    ${noteHTML}
                </div>
                <div class="flex items-center">
                    <span class="font-semibold text-right ${config.color} mr-4 ${isPaid ? 'line-through' : ''}">${formatRupiah(amount)}</span>
                    <div class="flex items-center">${actionButtons}</div>
                </div>`;
            return itemDiv;
        }
        
        function updateOverallSummary(records) {
            const totalIncome = records.filter(r => r.type === 'income').reduce((sum, item) => sum + item.amount, 0);
            const totalExpenses = records.filter(r => r.type === 'expense').reduce((sum, item) => sum + item.amount, 0);
            const totalSavings = records.filter(r => r.type === 'savings').reduce((sum, item) => sum + item.amount, 0);
            const totalDebts = records.filter(r => r.type === 'debt' && !r.isPaid).reduce((sum, item) => sum + item.amount, 0);
            const totalReceivables = records.filter(r => r.type === 'receivable' && !r.isPaid).reduce((sum, item) => sum + item.amount, 0);
            const remainingBalance = totalIncome - totalExpenses - totalSavings;

            summaryElements.totalIncome.textContent = formatRupiah(totalIncome);
            summaryElements.totalExpenses.textContent = formatRupiah(totalExpenses);
            summaryElements.totalSavings.textContent = formatRupiah(totalSavings);
            summaryElements.totalDebts.textContent = formatRupiah(totalDebts);
            summaryElements.totalReceivables.textContent = formatRupiah(totalReceivables);
            summaryElements.remainingBalance.textContent = formatRupiah(remainingBalance);
        }

        function updateFormUI() {
            const type = formTypeSelect.value;
            const config = {
                income: { cat: ['Gaji', 'Transfer Masuk', 'Bonus', 'Hasil Usaha', 'Lainnya'], btn: 'Tambah Pendapatan', color: 'cyan' },
                expense: { cat: ['Rumah', 'Tagihan', 'Jajan', 'Kendaraan', 'Transfer', 'Belanja', 'Kesehatan', 'Hiburan', 'Pendidikan', 'Lainnya'], btn: 'Tambah Pengeluaran', color: 'red' },
                savings: { cat: null, btn: 'Tambah Tabungan', color: 'green' },
                debt: { cat: null, btn: 'Tambah Hutang', color: 'yellow' },
                receivable: { cat: null, btn: 'Tambah Piutang', color: 'blue' }
            };
            
            const currentConfig = config[type];
            formSubmitBtn.textContent = currentConfig.btn;
            formSubmitBtn.className = `w-full bg-${currentConfig.color}-500 hover:bg-${currentConfig.color}-600 font-semibold rounded-lg px-4 py-2 transition-colors mt-2`;
            
            if (currentConfig.cat) {
                formCategoryContainer.classList.remove('hidden');
                formCategorySelect.innerHTML = currentConfig.cat.map(c => `<option value="${c}">${c}</option>`).join('');
            } else {
                formCategoryContainer.classList.add('hidden');
            }
        }
        function populateDatalist() {
            const names = [...new Set(allRecords.map(r => r.name))];
            getEl('name-suggestions').innerHTML = names.map(name => `<option value="${name}"></option>`).join('');
        }

        // --- FEATURE: KELOLA NAMA & FILTER RINGKASAN ---
        function populateSummaryFilters(records) {
            const yearFilter = summaryElements.yearFilter;
            const currentSelectedYear = yearFilter.value;

            const years = [...new Set(records.map(r => r.date.toDate().getFullYear()))];
            yearFilter.innerHTML = '<option value="-1">Semua Tahun</option>';
            years.sort((a, b) => b - a).forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });

            if (years.includes(parseInt(currentSelectedYear))) {
                yearFilter.value = currentSelectedYear;
            }
        }

        function handleSummaryFilterChange() {
            const selectedMonth = parseInt(summaryElements.monthFilter.value);
            const selectedYear = parseInt(summaryElements.yearFilter.value);

            let recordsForSummary = allRecords;

            if (selectedYear !== -1) {
                recordsForSummary = recordsForSummary.filter(r => r.date.toDate().getFullYear() === selectedYear);
            }
            if (selectedMonth !== -1) {
                recordsForSummary = recordsForSummary.filter(r => r.date.toDate().getMonth() === selectedMonth);
            }
            
            updateOverallSummary(recordsForSummary);
        }


        function openManageNamesModal() {
            const namesByType = allRecords.reduce((acc, curr) => {
                if (!acc[curr.type]) acc[curr.type] = new Set();
                acc[curr.type].add(curr.name);
                return acc;
            }, {});

            manageNamesContent.innerHTML = '';
            const typeLabels = { income: 'Pendapatan', expense: 'Pengeluaran', savings: 'Tabungan', debt: 'Hutang', receivable: 'Piutang' };

            Object.entries(namesByType).forEach(([type, names]) => {
                if (names.size === 0) return;

                const container = document.createElement('div');
                container.className = 'space-y-2';

                const title = document.createElement('h4');
                title.className = 'text-lg font-bold text-slate-300 border-b border-slate-600 pb-1';
                title.textContent = typeLabels[type];
                container.appendChild(title);

                const controlWrapper = document.createElement('div');
                controlWrapper.className = 'flex items-center gap-2';
                
                const select = document.createElement('select');
                select.className = 'w-full bg-slate-700 border border-slate-600 rounded-lg p-2 manage-name-select';
                
                [...names].sort().forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    select.appendChild(option);
                });
                controlWrapper.appendChild(select);

                const editButton = document.createElement('button');
                editButton.className = 'edit-saved-name-btn flex-shrink-0 bg-slate-600 hover:bg-slate-500 text-white font-semibold rounded-lg p-2 transition-colors';
                editButton.innerHTML = editIconSVG;
                editButton.dataset.type = type;
                controlWrapper.appendChild(editButton);

                container.appendChild(controlWrapper);
                manageNamesContent.appendChild(container);
            });

            manageNamesModal.classList.remove('hidden');
        }
        
        async function handleEditSavedName(e) {
            const button = e.target.closest('button');
            const type = button.dataset.type;
            const selectElement = button.previousElementSibling;
            const oldName = selectElement.value;

            if (!oldName) {
                await showAlert("Tidak ada nama yang dipilih untuk diedit.");
                return;
            }

            const newNameRaw = await showPrompt(`Edit nama "${oldName}" menjadi:`, oldName, 'Edit Nama Tersimpan');
            if (!newNameRaw || newNameRaw.trim() === '' || newNameRaw.trim() === oldName) return;
            const newName = newNameRaw.trim();
            
            const confirmed = await showConfirm(`Yakin ingin mengubah semua transaksi "${oldName}" menjadi "${newName}"? Aksi ini tidak dapat dibatalkan.`);
            if (!confirmed) return;

            try {
                const q = query(transactionsCol, where("type", "==", type), where("name", "==", oldName));
                const querySnapshot = await getDocs(q);
                
                if(querySnapshot.empty) {
                    await showAlert("Tidak ada transaksi dengan nama tersebut untuk diubah.");
                    return;
                }

                const batch = writeBatch(db);
                querySnapshot.forEach(doc => {
                    batch.update(doc.ref, { name: newName });
                });
                await batch.commit();

                await logAction('Kelola Nama', `Mengubah "${oldName}" menjadi "${newName}" (${querySnapshot.size} transaksi)`);
                await showAlert('Nama transaksi berhasil diperbarui untuk semua entri terkait.', 'Sukses');
                openManageNamesModal(); // Refresh modal content
            } catch (error) {
                console.error("Gagal mengubah nama transaksi:", error);
                await showAlert("Terjadi kesalahan saat mengubah nama.", "Error");
            }
        }

        // --- CALCULATOR LOGIC (REWRITTEN & FIXED) ---
        const calculator = {
            displayValue: '0',
            firstOperand: null,
            waitingForSecondOperand: false,
            operator: null,
        };
        
        function formatNumberString(str) {
            if (typeof str !== 'string') str = String(str);
            const [integerPart, decimalPart] = str.split('.');
            const unformattedInteger = integerPart.replace(/,/g, '');
            const formattedInteger = new Intl.NumberFormat('id-ID').format(unformattedInteger);
            return decimalPart != null ? `${formattedInteger},${decimalPart}` : formattedInteger;
        }

        function updateCalculatorDisplay() {
            calculatorDisplay.textContent = formatNumberString(calculator.displayValue.replace('.', ','));
        }
        
        function inputDigit(digit) {
            const { displayValue, waitingForSecondOperand } = calculator;
            if (waitingForSecondOperand) {
                calculator.displayValue = digit;
                calculator.waitingForSecondOperand = false;
            } else {
                calculator.displayValue = displayValue === '0' ? digit : displayValue + digit;
            }
        }
        
        function inputDecimal() {
            if (calculator.waitingForSecondOperand) {
                calculator.displayValue = '0.';
                calculator.waitingForSecondOperand = false;
                return;
            }
            if (!calculator.displayValue.includes('.')) {
                calculator.displayValue += '.';
            }
        }

        function handleOperator(nextOperator) {
            const { firstOperand, displayValue, operator } = calculator;
            const inputValue = parseFloat(displayValue);

            if (operator && calculator.waitingForSecondOperand) {
                calculator.operator = nextOperator;
                calculatorHistoryDisplay.textContent = `${formatNumberString(String(firstOperand))} ${nextOperator}`;
                return;
            }

            if (firstOperand === null && !isNaN(inputValue)) {
                calculator.firstOperand = inputValue;
            } else if (operator) {
                const result = performCalculation(firstOperand, inputValue, operator);
                calculator.displayValue = String(result);
                calculator.firstOperand = result;
            }

            calculator.waitingForSecondOperand = true;
            calculator.operator = nextOperator;
            calculatorHistoryDisplay.textContent = `${formatNumberString(calculator.displayValue)} ${nextOperator}`;
        }
        
        function performCalculation(first, second, op) {
            if (op === '+') return first + second;
            if (op === '−') return first - second;
            if (op === '×') return first * second;
            if (op === '÷') return first / second;
            return second;
        }

        function resetCalculator() {
            calculator.displayValue = '0';
            calculator.firstOperand = null;
            calculator.waitingForSecondOperand = false;
            calculator.operator = null;
            calculatorHistoryDisplay.innerHTML = '&nbsp;';
            updateCalculatorDisplay();
        }
        
        function inputBackspace() {
            if (calculator.waitingForSecondOperand) return;
            calculator.displayValue = calculator.displayValue.length > 1 ? calculator.displayValue.slice(0, -1) : '0';
        }

        function inputSign() {
             if (calculator.displayValue === '0') return;
             calculator.displayValue = calculator.displayValue.startsWith('-')
                ? calculator.displayValue.slice(1)
                : `-${calculator.displayValue}`;
        }
        
        function handleCalculatorAction(action, keyContent) {
            switch(action) {
                case 'add': handleOperator('+'); break;
                case 'subtract': handleOperator('−'); break;
                case 'multiply': handleOperator('×'); break;
                case 'divide': handleOperator('÷'); break;
                case 'decimal': inputDecimal(); break;
                case 'clear': resetCalculator(); break;
                case 'backspace': inputBackspace(); break;
                case 'sign': inputSign(); break;
                case 'calculate':
                    if (calculator.operator && !calculator.waitingForSecondOperand) {
                        const { firstOperand, displayValue, operator } = calculator;
                        const secondOperand = parseFloat(displayValue);
                        const result = performCalculation(firstOperand, secondOperand, operator);

                        calculatorHistoryDisplay.textContent = `${formatNumberString(String(firstOperand))} ${operator} ${formatNumberString(displayValue)} =`;
                        calculator.displayValue = String(result);
                        calculator.operator = null;
                        calculator.firstOperand = null; 
                        calculator.waitingForSecondOperand = true;
                    }
                    break;
                default:
                    if (/\d/.test(keyContent)) {
                        inputDigit(keyContent);
                    }
                    break;
            }
            updateCalculatorDisplay();
        }

        function handleKeyPress(e) {
            const key = e.key;
            let targetButton;
            if (key >= '0' && key <= '9') {
                targetButton = calculatorKeys.querySelector(`[data-key="${key}"]`);
            } else if (key === '.' || key === ',') {
                targetButton = calculatorKeys.querySelector('[data-action="decimal"]');
            } else if (key === '+') {
                targetButton = calculatorKeys.querySelector('[data-action="add"]');
            } else if (key === '-') {
                targetButton = calculatorKeys.querySelector('[data-action="subtract"]');
            } else if (key === '*') {
                targetButton = calculatorKeys.querySelector('[data-action="multiply"]');
            } else if (key === '/') {
                targetButton = calculatorKeys.querySelector('[data-action="divide"]');
            } else if (key === 'Enter' || key === '=') {
                targetButton = calculatorKeys.querySelector('[data-action="calculate"]');
            } else if (key.toLowerCase() === 'c' || key === 'Escape') {
                targetButton = calculatorKeys.querySelector('[data-action="clear"]');
            } else if (key === 'Backspace') {
                targetButton = calculatorKeys.querySelector('[data-action="backspace"]');
            } else {
                return;
            }
            
            e.preventDefault();
            if (targetButton) {
                targetButton.click();
                targetButton.classList.add('key-pressed');
                setTimeout(() => { targetButton.classList.remove('key-pressed'); }, 100);
            }
        }


        // --- EVENT LISTENERS ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = usernameSelect.value;
            const password = passwordInput.value;
            if (USERS[username] && USERS[username] === password) {
                currentUser = username;
                sessionStorage.setItem('budgetUser', currentUser);
                loginScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                currentUserDisplay.textContent = currentUser;
                logAction("User Masuk", `User '${currentUser}' telah bergabung.`);
                loginError.classList.add('hidden');
                passwordInput.value = '';
                // *** PERBAIKAN DI SINI: Memulai AudioContext setelah interaksi pengguna ***
                Tone.start();
            } else {
                loginError.classList.remove('hidden');
            }
        });
        
        logoutBtn.addEventListener('click', () => {
            logAction("User Keluar", `User '${currentUser}' telah keluar.`);
            currentUser = null;
            sessionStorage.removeItem('budgetUser');
            appContainer.classList.add('hidden');
            loginScreen.classList.remove('hidden');
        });
        
        formTypeSelect.addEventListener('change', updateFormUI);
        mainForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = formNameInput.value.trim();
            const amount = parseFloat(formAmountInput.value);
            const date = formDateInput.value;
            const note = formNoteInput.value.trim();

            if (!name || isNaN(amount) || amount <= 0 || !date) {
                await showAlert("Nama, Jumlah (angka positif), dan Tanggal wajib diisi.");
                return;
            }

            const newRecord = {
                type: formTypeSelect.value, name, amount, user: currentUser,
                date: new Date(date + 'T00:00:00'), // Store as local date
                note: note || "", // Store empty string if no note
                timestamp: serverTimestamp(), isPaid: false,
            };
            if(!formCategoryContainer.classList.contains('hidden')){ newRecord.category = formCategorySelect.value; }
            
            try {
                await addDoc(transactionsCol, newRecord);
                await logAction(`Tambah ${newRecord.type}`, `${name} - ${formatRupiah(amount)}`);
                mainForm.reset();
                formDateInput.value = getTodayString();
                updateFormUI();
            } catch (error) { await showAlert("Gagal menyimpan data ke server."); }
        });
        
        allRecordsList.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const id = button.dataset.id;
            const recordRef = doc(db, "transactions", id);
            const record = allRecords.find(r => r.id === id);

            if (button.classList.contains('delete-btn')) {
                if (await showConfirm('Anda yakin ingin menghapus transaksi ini?')) {
                    try {
                        await deleteDoc(recordRef);
                        await logAction(`Hapus ${record.type}`, `${record.name} - ${formatRupiah(record.amount)}`);
                    } catch (error) { console.error("Error menghapus:", error); }
                }
            } else if (button.classList.contains('toggle-paid-btn')) {
                 const newPaidStatus = !record.isPaid;
                 try {
                    await updateDoc(recordRef, { isPaid: newPaidStatus });
                    const status = newPaidStatus ? 'Lunas' : 'Belum Lunas';
                    await logAction(`Ubah Status ${record.type}`, `${record.name} menjadi ${status}`);
                    filterControls.applyBtn.click();
                 } catch (error) { console.error("Error update status:", error); }
            } else if (button.classList.contains('edit-btn')) {
                editingRecordId = id;
                getEl('edit-name').value = record.name;
                getEl('edit-amount').value = record.amount;
                getEl('edit-date').value = toInputDate(record.date);
                getEl('edit-note').value = record.note || '';
                editModal.classList.remove('hidden');
            }
        });
        
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!editingRecordId) return;

            const recordRef = doc(db, 'transactions', editingRecordId);
            const newName = getEl('edit-name').value.trim();
            const newAmount = parseFloat(getEl('edit-amount').value);
            const newDate = getEl('edit-date').value;
            const newNote = getEl('edit-note').value.trim();

            if(!newName || isNaN(newAmount) || newAmount <= 0 || !newDate) {
                 await showAlert("Nama, Jumlah (angka positif), dan Tanggal wajib diisi.");
                return;
            }
            
            try {
                await updateDoc(recordRef, { name: newName, amount: newAmount, date: new Date(newDate + 'T00:00:00'), note: newNote });
                await logAction(`Edit Transaksi`, `ID ${editingRecordId} diubah menjadi ${newName} - ${formatRupiah(newAmount)}`);
                editModal.classList.add('hidden');
                editingRecordId = null;
            } catch (error) { console.error("Gagal edit:", error); }
        });
        
        cancelEditBtn.addEventListener('click', () => editModal.classList.add('hidden'));

        filterControls.applyBtn.addEventListener('click', () => {
             const typeFilter = filterControls.type.value;
             const nameFilter = filterControls.name.value.toLowerCase().trim();
             const startDate = filterControls.start.value ? new Date(filterControls.start.value).setHours(0,0,0,0) : null;
             const endDate = filterControls.end.value ? new Date(filterControls.end.value).setHours(23,59,59,999) : null;

             let filteredRecords = allRecords;
             if (typeFilter !== 'semua') filteredRecords = filteredRecords.filter(r => r.type === typeFilter);
             if (nameFilter) filteredRecords = filteredRecords.filter(r => r.name.toLowerCase().includes(nameFilter));
             if (startDate) filteredRecords = filteredRecords.filter(r => r.date.toMillis() >= startDate);
             if (endDate) filteredRecords = filteredRecords.filter(r => r.date.toMillis() <= endDate);
             
             renderRecords(filteredRecords);

             const isActiveFilter = typeFilter !== 'semua' || nameFilter || startDate || endDate;
             if (isActiveFilter) {
                 let netFlow = 0;
                 // *** PERBAIKAN DI SINI: Logika arus kas yang disempurnakan ***
                 filteredRecords.forEach(record => {
                    switch (record.type) {
                        case 'income':
                            netFlow += record.amount;
                            break;
                        case 'expense':
                        case 'savings':
                            netFlow -= record.amount;
                            break;
                        case 'debt':
                             if (!record.isPaid) { netFlow += record.amount; }
                            break;
                        case 'receivable':
                             if (!record.isPaid) { netFlow -= record.amount; }
                            break;
                    }
                 });
                 
                 filterControls.filteredTotal.textContent = formatRupiah(netFlow);
                 filterControls.filteredTotal.className = `font-bold ${netFlow >= 0 ? 'text-cyan-400' : 'text-red-400'}`;
                 filterControls.summaryContainer.classList.remove('hidden');
             } else {
                 filterControls.summaryContainer.classList.add('hidden');
             }
        });
        
        filterControls.resetBtn.addEventListener('click', () => {
            filterControls.type.value = 'semua';
            filterControls.name.value = '';
            filterControls.start.value = '';
            filterControls.end.value = '';
            renderRecords(allRecords);
            filterControls.summaryContainer.classList.add('hidden');
        });

        manageNamesBtn.addEventListener('click', openManageNamesModal);
        closeManageNamesBtn.addEventListener('click', () => manageNamesModal.classList.add('hidden'));
        manageNamesContent.addEventListener('click', (e) => {
            if (e.target.closest('.edit-saved-name-btn')) { handleEditSavedName(e); }
        });
        
        historyBtn.addEventListener('click', () => {
             historyModal.classList.remove('hidden');
        });
        closeHistoryBtn.addEventListener('click', () => historyModal.classList.add('hidden'));

        summaryElements.monthFilter.addEventListener('change', handleSummaryFilterChange);
        summaryElements.yearFilter.addEventListener('change', handleSummaryFilterChange);
        
        // FAB & Calculator Listeners
        fabMainBtn.addEventListener('click', () => {
            fabMenu.classList.toggle('hidden');
            fabMainBtn.classList.toggle('rotate-45');
        });

        calculatorBtn.addEventListener('click', () => {
            calculatorModal.classList.remove('hidden');
            document.addEventListener('keydown', handleKeyPress); 
            fabMenu.classList.add('hidden');
            fabMainBtn.classList.remove('rotate-45');
        });
        
        chatBtn.addEventListener('click', () => {
            chatModal.classList.remove('hidden');
            chatNotificationDot.classList.add('hidden');
            isChatOpen = true; // *** PERBAIKAN DI SINI ***
            fabMenu.classList.add('hidden');
            fabMainBtn.classList.remove('rotate-45');
            chatMessagesArea.scrollTop = chatMessagesArea.scrollHeight;
        });

        const hideCalculator = () => {
            calculatorModal.classList.add('hidden');
            document.removeEventListener('keydown', handleKeyPress);
        }

        closeCalculatorBtn.addEventListener('click', () => {
            hideCalculator();
            resetCalculator();
        });
        
        closeChatBtn.addEventListener('click', () => {
            chatModal.classList.add('hidden');
            isChatOpen = false; // *** PERBAIKAN DI SINI ***
        });
        
        calculatorModal.addEventListener('click', (e) => {
            if (e.target === calculatorModal) {
                hideCalculator(); // Hanya sembunyikan, jangan reset
            }
        });
        
        calculatorKeys.addEventListener('click', (e) => {
             const key = e.target.closest('button');
            if (!key) return;
            handleCalculatorAction(key.dataset.action, key.textContent.trim());
        });

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageText = chatInput.value.trim();
            if (messageText) {
                try {
                    await addDoc(chatCol, {
                        text: messageText,
                        user: currentUser,
                        timestamp: serverTimestamp()
                    });
                    chatInput.value = '';
                } catch(error) {
                    console.error("Gagal mengirim pesan:", error);
                    showAlert("Gagal mengirim pesan.");
                }
            }
        });

        // --- REAL-TIME LISTENER ---
        onSnapshot(query(transactionsCol, orderBy("date", "desc")), (snapshot) => {
            allRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAll(allRecords);
        });
        
        onSnapshot(query(auditLogCol, orderBy("timestamp", "desc")), (snapshot) => {
            auditLogContent.innerHTML = '';
            if (snapshot.empty) {
                auditLogContent.innerHTML = `<p class="text-slate-500 text-center py-4 italic">Belum ada histori perubahan.</p>`;
                return;
            }
            snapshot.docs.forEach(doc => {
                 const log = doc.data();
                 const logEl = document.createElement('div');
                 logEl.className = 'text-sm text-slate-300 p-2 border-b border-slate-700';
                 logEl.innerHTML = `<span class="font-semibold text-cyan-400">${log.user}</span>: ${log.action} <span class="text-slate-400">(${log.details})</span> - <span class="text-xs">${formatDate(log.timestamp)}</span>`;
                 auditLogContent.appendChild(logEl);
            });
        });
        
        const synth = new Tone.Synth().toDestination();

        onSnapshot(query(chatCol, orderBy("timestamp")), (snapshot) => {
            snapshot.docChanges().forEach(change => {
                if (change.type === "added") {
                    const msg = change.doc.data();
                    
                    if (!isInitialChatLoad && msg.user !== currentUser) {
                        synth.triggerAttackRelease("C5", "8n");
                        if (!isChatOpen) { // *** PERBAIKAN DI SINI ***
                             chatNotificationDot.classList.remove('hidden');
                        }
                    }

                    const msgWrapper = document.createElement('div');
                    const isCurrentUser = msg.user === currentUser;

                    msgWrapper.className = `flex flex-col ${isCurrentUser ? 'items-end' : 'items-start'}`;

                    const bubble = document.createElement('div');
                    bubble.className = `max-w-xs md:max-w-md p-3 rounded-xl ${isCurrentUser ? 'bg-cyan-600 rounded-br-none' : 'bg-slate-600 rounded-bl-none'}`;
                    
                    const userEl = document.createElement('p');
                    userEl.className = `text-xs font-bold ${isCurrentUser ? 'text-cyan-200' : 'text-slate-300'}`;
                    userEl.textContent = msg.user;
                    
                    const textEl = document.createElement('p');
                    textEl.className = 'text-white text-sm';
                    textEl.textContent = msg.text;

                    const timeEl = document.createElement('p');
                    timeEl.className = 'text-xs text-slate-400 mt-1 text-right';
                    timeEl.textContent = msg.timestamp ? msg.timestamp.toDate().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit'}) : '';
                    
                    bubble.appendChild(userEl);
                    bubble.appendChild(textEl);
                    bubble.appendChild(timeEl);
                    msgWrapper.appendChild(bubble);
                    chatMessagesArea.appendChild(msgWrapper);
                }
            });
            isInitialChatLoad = false;
            chatMessagesArea.scrollTop = chatMessagesArea.scrollHeight;
        });

        // --- INISIALISASI ---
        currentUser = sessionStorage.getItem('budgetUser');
        if (currentUser && USERS[currentUser]) {
            loginScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');
            currentUserDisplay.textContent = currentUser;
        } else {
            sessionStorage.removeItem('budgetUser');
        }

        const now = new Date();
        summaryElements.monthFilter.value = now.getMonth();
        // Cek dulu apakah ada tahun di filter sebelum set value
        if(summaryElements.yearFilter.options.length > 1){
            summaryElements.yearFilter.value = now.getFullYear();
        }
        
        formDateInput.value = getTodayString();
        updateFormUI();
        updateCalculatorDisplay();
    </script>
</body>
</html>
