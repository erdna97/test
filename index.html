<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Anggaran (Online & Kolaboratif)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="bg-slate-900 text-white flex items-center justify-center min-h-screen p-4">

    <!-- Layar Login / Registrasi -->
    <div id="auth-screen" class="w-full max-w-sm">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl">
            <h2 id="auth-title" class="text-3xl font-bold text-center text-cyan-400 mb-6">Masuk</h2>
            <p id="auth-error" class="bg-red-500/20 text-red-300 text-sm p-3 rounded-lg mb-4 text-center hidden"></p>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="auth-email" class="block text-slate-300 mb-1">Email</label>
                    <input type="email" id="auth-email" required class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-cyan-500 transition">
                </div>
                <div>
                    <label for="auth-password" class="block text-slate-300 mb-1">Password</label>
                    <input type="password" id="auth-password" required class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-cyan-500 transition">
                </div>
                <button type="submit" id="auth-submit-btn" class="w-full bg-cyan-500 hover:bg-cyan-600 font-semibold rounded-lg p-3 transition-colors !mt-6">Masuk</button>
            </form>
            <div class="relative my-6">
              <div class="absolute inset-0 flex items-center" aria-hidden="true">
                <div class="w-full border-t border-slate-600"></div>
              </div>
              <div class="relative flex justify-center text-sm">
                <span class="bg-slate-800 px-2 text-slate-400">Atau</span>
              </div>
            </div>
            <button id="google-signin-btn" class="w-full bg-slate-700 hover:bg-slate-600 font-semibold rounded-lg p-3 transition-colors flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="google" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 126 21.2 172.9 56.6l-67.4 66.8C314.6 95.8 282.5 80 248 80c-73.2 0-132.3 59.2-132.3 132S174.8 344 248 344c41.4 0 76.7-14.4 102.8-38.6l67.4 66.8C391.1 445.4 326.6 480 248 480c-119.3 0-216-96.7-216-216S128.7 40 248 40c74.4 0 134.3 26.1 179.4 69.8l-2.4 2.3C458.7 155.7 488 205.9 488 261.8z"></path></svg>
                Masuk dengan Google
            </button>
            <p class="text-center text-sm text-slate-400 mt-6">
                <span id="auth-switch-text">Belum punya akun?</span>
                <button id="auth-switch-btn" class="font-semibold text-cyan-400 hover:text-cyan-300">Daftar di sini</button>
            </p>
        </div>
    </div>

    <!-- Kontainer Aplikasi Utama (Hidden by default) -->
    <div id="app-container" class="w-full max-w-7xl hidden">
        <div class="bg-slate-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-8">
            <header class="text-center">
                <h1 class="text-3xl md:text-4xl font-bold text-cyan-400">Kalkulator Anggaran Lengkap</h1>
                <p class="text-slate-400 mt-2">Masuk sebagai: <span id="current-user-display" class="font-bold"></span></p>
                 <div class="mt-4 flex justify-center gap-4">
                    <button id="manage-names-btn" class="bg-gray-600 hover:bg-gray-700 font-semibold rounded-lg px-4 py-2 transition-colors text-sm">Kelola Nama</button>
                    <button id="history-btn" class="bg-indigo-600 hover:bg-indigo-700 font-semibold rounded-lg px-4 py-2 transition-colors text-sm">Lihat Histori</button>
                    <button id="logout-btn" class="bg-red-600 hover:bg-red-700 font-semibold rounded-lg px-4 py-2 transition-colors text-sm">Logout</button>
                </div>
            </header>

            <!-- Area Input -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Kolom Pendapatan -->
                <div class="space-y-4 bg-slate-900/50 p-6 rounded-xl">
                    <h2 class="text-2xl font-bold text-cyan-400">Input Pendapatan</h2>
                    <form id="income-form" class="space-y-2">
                        <input data-field="name" type="text" list="income-names" placeholder="Nama Pemasukan" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <datalist id="income-names"></datalist>
                        <input data-field="amount" type="number" placeholder="Jumlah" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <select data-field="category" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                            <option value="Gaji">Gaji</option>
                            <option value="Transfer">Transfer Masuk</option>
                            <option value="Bonus">Bonus</option>
                            <option value="Hasil Usaha">Hasil Usaha</option>
                            <option value="Lainnya">Lainnya</option>
                        </select>
                        <input data-field="date" type="date" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-slate-400">
                        <input data-field="note" type="text" placeholder="Catatan (opsional)" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 font-semibold rounded-lg px-4 py-2 transition-colors !mt-4">Tambah</button>
                    </form>
                </div>

                <!-- Kolom Pengeluaran -->
                <div class="space-y-4 bg-slate-900/50 p-6 rounded-xl">
                    <h2 class="text-2xl font-bold text-red-400">Input Pengeluaran</h2>
                    <form id="expense-form" class="space-y-2">
                        <input data-field="name" type="text" list="expense-names" placeholder="Nama Pengeluaran" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <datalist id="expense-names"></datalist>
                        <input data-field="amount" type="number" placeholder="Jumlah" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                         <select data-field="category" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                            <option value="Rumah">Kebutuhan Rumah</option>
                            <option value="Topup & Tagihan">Topup & Tagihan</option>
                            <option value="Jajan & Makanan">Jajan & Makanan</option>
                            <option value="Kendaraan">Kendaraan</option>
                            <option value="Transfer">Transfer Keluar</option>
                            <option value="Belanja">Belanja</option>
                            <option value="Kesehatan">Kesehatan</option>
                            <option value="Hiburan">Hiburan</option>
                            <option value="Pendidikan">Pendidikan</option>
                            <option value="Lainnya">Lainnya</option>
                        </select>
                        <input data-field="date" type="date" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-slate-400">
                        <input data-field="note" type="text" placeholder="Catatan (opsional)" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <button type="submit" class="w-full bg-red-500 hover:bg-red-600 font-semibold rounded-lg px-4 py-2 transition-colors !mt-4">Tambah</button>
                    </form>
                </div>

                <!-- Kolom Tabungan -->
                <div class="space-y-4 bg-slate-900/50 p-6 rounded-xl">
                    <h2 class="text-2xl font-bold text-green-400">Input Tabungan</h2>
                    <form id="savings-form" class="space-y-2">
                        <input data-field="name" type="text" list="savings-names" placeholder="Tujuan Tabungan" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <datalist id="savings-names"></datalist>
                        <input data-field="amount" type="number" placeholder="Jumlah" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <input data-field="date" type="date" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-slate-400">
                        <input data-field="note" type="text" placeholder="Catatan (opsional)" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <div class="h-[3.35rem]"></div> <!-- Spacer -->
                        <button type="submit" class="w-full bg-green-500 hover:bg-green-600 font-semibold rounded-lg px-4 py-2 transition-colors !mt-4">Tambah</button>
                    </form>
                </div>
                
                <!-- Kolom Hutang -->
                <div class="space-y-4 bg-slate-900/50 p-6 rounded-xl">
                    <h2 class="text-2xl font-bold text-yellow-400">Input Hutang</h2>
                    <form id="debt-form" class="space-y-2">
                        <input data-field="name" type="text" list="debt-names" placeholder="Deskripsi Hutang" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <datalist id="debt-names"></datalist>
                        <input data-field="amount" type="number" placeholder="Jumlah" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <input data-field="date" type="date" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-slate-400">
                        <input data-field="note" type="text" placeholder="Catatan (opsional)" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <div class="h-[3.35rem]"></div> <!-- Spacer -->
                        <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 font-semibold rounded-lg px-4 py-2 transition-colors !mt-4">Tambah</button>
                    </form>
                </div>

                <!-- Kolom Piutang -->
                <div class="space-y-4 bg-slate-900/50 p-6 rounded-xl">
                    <h2 class="text-2xl font-bold text-blue-400">Input Piutang</h2>
                    <form id="receivable-form" class="space-y-2">
                        <input data-field="name" type="text" list="receivable-names" placeholder="Deskripsi Piutang" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <datalist id="receivable-names"></datalist>
                        <input data-field="amount" type="number" placeholder="Jumlah" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <input data-field="date" type="date" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-slate-400">
                         <input data-field="note" type="text" placeholder="Catatan (opsional)" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <div class="h-[3.35rem]"></div> <!-- Spacer -->
                        <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 font-semibold rounded-lg px-4 py-2 transition-colors !mt-4">Tambah</button>
                    </form>
                </div>
            </div>

            <div class="bg-slate-900/50 p-6 rounded-xl space-y-4">
                <h2 class="text-2xl font-bold text-white text-center">Evaluasi & Filter Transaksi</h2>
                <div id="filter-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4 items-end">
                    <div>
                        <label for="filter-type" class="block text-sm font-medium text-slate-300 mb-1">Tipe Transaksi</label>
                        <select id="filter-type" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                            <option value="semua">Semua Tipe</option>
                            <option value="income">Pendapatan</option>
                            <option value="expense">Pengeluaran</option>
                            <option value="savings">Tabungan</option>
                            <option value="debt">Hutang</option>
                            <option value="receivable">Piutang</option>
                        </select>
                    </div>
                    <div>
                        <label for="filter-start-date" class="block text-sm font-medium text-slate-300 mb-1">Dari Tanggal</label>
                        <input type="date" id="filter-start-date" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-slate-400">
                    </div>
                    <div>
                        <label for="filter-end-date" class="block text-sm font-medium text-slate-300 mb-1">Sampai Tanggal</label>
                        <input type="date" id="filter-end-date" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-slate-400">
                    </div>
                     <div>
                        <label for="filter-name" class="block text-sm font-medium text-slate-300 mb-1">Cari Nama</label>
                        <input type="text" id="filter-name" placeholder="cth: Listrik" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                    </div>
                    <div>
                        <label id="filter-category-label" for="filter-category" class="block text-sm font-medium text-slate-300 mb-1">Kategori</label>
                        <select id="filter-category" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2"></select>
                    </div>
                    <div class="flex gap-2">
                        <button id="apply-filter-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 font-semibold rounded-lg px-4 py-2 transition-colors">Terapkan</button>
                        <button id="reset-filter-btn" class="w-full bg-slate-600 hover:bg-slate-700 font-semibold rounded-lg px-4 py-2 transition-colors">Reset</button>
                    </div>
                </div>
                <div id="filtered-summary-container" class="pt-4 hidden">
                     <h4 class="text-lg font-semibold text-center text-indigo-300 mb-2">Ringkasan Hasil Filter</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-center p-4 bg-slate-800/50 rounded-lg">
                        <div id="filtered-income-summary" class="hidden"><p class="text-slate-400 text-xs">Pendapatan</p><p id="filtered-income" class="text-lg font-semibold text-cyan-400">Rp 0</p></div>
                        <div id="filtered-expenses-summary" class="hidden"><p class="text-slate-400 text-xs">Pengeluaran</p><p id="filtered-expenses" class="text-lg font-semibold text-red-400">Rp 0</p></div>
                        <div id="filtered-savings-summary" class="hidden"><p class="text-slate-400 text-xs">Tabungan</p><p id="filtered-savings" class="text-lg font-semibold text-green-400">Rp 0</p></div>
                        <div id="filtered-cashflow-summary" class="hidden"><p class="text-slate-400 text-xs">Arus Kas</p><p id="filtered-cashflow" class="text-lg font-bold text-white">Rp 0</p></div>
                    </div>
                </div>
            </div>

            <div class="bg-slate-900/50 p-6 rounded-xl">
                <h2 id="records-title" class="text-2xl font-bold text-white text-center mb-4">Semua Catatan Transaksi</h2>
                <div id="all-records-list" class="space-y-2 max-h-96 overflow-y-auto pr-2 custom-scrollbar"></div>
            </div>
            
            <footer class="bg-slate-900/70 p-6 rounded-xl mt-6">
                <h3 class="text-2xl font-bold text-center text-cyan-300 mb-4">Ringkasan Keuangan Total</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-center">
                    <div><p class="text-slate-400 text-sm">Total Pendapatan</p><p id="total-income" class="text-xl font-semibold text-cyan-400">Rp 0</p></div>
                    <div><p class="text-slate-400 text-sm">Total Pengeluaran</p><p id="total-expenses" class="text-xl font-semibold text-red-400">Rp 0</p></div>
                    <div><p class="text-slate-400 text-sm">Total Tabungan</p><p id="total-savings" class="text-xl font-semibold text-green-400">Rp 0</p></div>
                    <div><p class="text-slate-400 text-sm">Hutang Aktif</p><p id="total-debts" class="text-xl font-semibold text-yellow-400">Rp 0</p></div>
                    <div><p class="text-slate-400 text-sm">Piutang Aktif</p><p id="total-receivables" class="text-xl font-semibold text-blue-400">Rp 0</p></div>
                    <div><p class="text-slate-400 text-sm font-bold">Sisa Uang</p><p id="remaining-balance" class="text-xl font-bold text-white">Rp 0</p></div>
                </div>
            </footer>
        </div>
    </div>
    
    <!-- MODALS -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-md space-y-4">
            <h3 class="text-2xl font-bold text-white">Edit Catatan</h3>
            <form id="edit-form" class="space-y-4">
                 <div>
                    <label for="edit-name" class="block text-sm font-medium text-slate-300 mb-1">Nama</label>
                    <input type="text" id="edit-name" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                </div>
                <div>
                    <label for="edit-amount" class="block text-sm font-medium text-slate-300 mb-1">Jumlah</label>
                    <input type="number" id="edit-amount" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                </div>
                <div id="edit-category-container" class="hidden">
                    <label for="edit-category" class="block text-sm font-medium text-slate-300 mb-1">Kategori</label>
                    <select id="edit-category" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2"></select>
                </div>
                <div>
                    <label for="edit-date" class="block text-sm font-medium text-slate-300 mb-1">Tanggal</label>
                    <input type="date" id="edit-date" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-slate-400">
                </div>
                 <div>
                    <label for="edit-note" class="block text-sm font-medium text-slate-300 mb-1">Catatan</label>
                    <input type="text" id="edit-note" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="cancel-edit-btn" class="bg-slate-600 hover:bg-slate-700 font-semibold rounded-lg px-4 py-2 transition-colors">Batal</button>
                    <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 font-semibold rounded-lg px-4 py-2 transition-colors">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>
    <div id="manage-names-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
         <div class="bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-2xl space-y-4">
            <div class="flex justify-between items-center">
                <h3 class="text-2xl font-bold text-white">Kelola Nama Tersimpan</h3>
                <button id="close-manage-names-btn" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="manage-names-content" class="grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[60vh] overflow-y-auto custom-scrollbar p-2"></div>
        </div>
    </div>
    <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-3xl space-y-4 flex flex-col">
            <div class="flex justify-between items-center flex-shrink-0">
                <h3 class="text-2xl font-bold text-white">Histori Transaksi</h3>
                <button id="close-history-btn" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="history-content-container" class="flex-grow overflow-y-auto custom-scrollbar p-1"></div>
        </div>
    </div>
     <div id="custom-alert-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-sm space-y-4 text-center">
            <h3 id="custom-alert-title" class="text-xl font-bold text-white">Peringatan</h3>
            <p id="custom-alert-message" class="text-slate-300"></p>
            <button id="custom-alert-ok-btn" class="bg-cyan-500 hover:bg-cyan-600 font-semibold rounded-lg px-6 py-2 transition-colors">OK</button>
        </div>
    </div>
    <div id="custom-confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-sm space-y-4 text-center">
            <h3 id="custom-confirm-title" class="text-xl font-bold text-white">Konfirmasi</h3>
            <p id="custom-confirm-message" class="text-slate-300"></p>
            <div class="flex justify-center gap-4 pt-4">
                <button id="custom-confirm-cancel-btn" class="bg-slate-600 hover:bg-slate-700 font-semibold rounded-lg px-6 py-2 transition-colors">Batal</button>
                <button id="custom-confirm-ok-btn" class="bg-red-500 hover:bg-red-600 font-semibold rounded-lg px-6 py-2 transition-colors">Ya</button>
            </div>
        </div>
    </div>
     <div id="custom-prompt-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-sm space-y-4">
            <h3 id="custom-prompt-title" class="text-xl font-bold text-white">Input Diperlukan</h3>
            <p id="custom-prompt-message" class="text-slate-300 mb-2"></p>
            <input type="text" id="custom-prompt-input" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
            <div class="flex justify-end gap-4 pt-4">
                <button id="custom-prompt-cancel-btn" class="bg-slate-600 hover:bg-slate-700 font-semibold rounded-lg px-6 py-2 transition-colors">Batal</button>
                <button id="custom-prompt-ok-btn" class="bg-cyan-500 hover:bg-cyan-600 font-semibold rounded-lg px-6 py-2 transition-colors">Simpan</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, updateDoc, deleteDoc, writeBatch, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL APP STATE ---
        let db, auth;
        let appId, userId;
        let allRecords = [], allHistory = [], savedNames = {};
        let editingRecordId = null;
        let recordsUnsubscribe, namesUnsubscribe, historyUnsubscribe;
        let isRegisterMode = false;

        // --- DOM ELEMENT SELECTION (Consolidated) ---
        const getEl = id => document.getElementById(id);
        const authScreen = getEl('auth-screen');
        const appContainer = getEl('app-container');
        const authForm = getEl('auth-form');
        const authTitle = getEl('auth-title');
        const authError = getEl('auth-error');
        const authSubmitBtn = getEl('auth-submit-btn');
        const authSwitchBtn = getEl('auth-switch-btn');
        const authSwitchText = getEl('auth-switch-text');
        const googleSigninBtn = getEl('google-signin-btn');
        const logoutBtn = getEl('logout-btn');
        const currentUserDisplay = getEl('current-user-display');
        const allRecordsList = getEl('all-records-list');
        const forms = {
            income: getEl('income-form'), expense: getEl('expense-form'), savings: getEl('savings-form'), debt: getEl('debt-form'), receivable: getEl('receivable-form'),
        };
        const summaryElements = {
            totalIncome: getEl('total-income'), totalExpenses: getEl('total-expenses'), totalSavings: getEl('total-savings'), totalDebts: getEl('total-debts'), totalReceivables: getEl('total-receivables'), remainingBalance: getEl('remaining-balance')
        };
        const filterControls = {
            type: getEl('filter-type'), start: getEl('filter-start-date'), end: getEl('filter-end-date'), name: getEl('filter-name'), category: getEl('filter-category'), categoryLabel: getEl('filter-category-label'), applyBtn: getEl('apply-filter-btn'), resetBtn: getEl('reset-filter-btn'), summaryContainer: getEl('filtered-summary-container'), 
            filteredIncome: getEl('filtered-income'), filteredIncomeSummary: getEl('filtered-income-summary'),
            filteredExpenses: getEl('filtered-expenses'), filteredExpensesSummary: getEl('filtered-expenses-summary'),
            filteredSavings: getEl('filtered-savings'), filteredSavingsSummary: getEl('filtered-savings-summary'),
            filteredCashflow: getEl('filtered-cashflow'), filteredCashflowSummary: getEl('filtered-cashflow-summary'),
            recordsTitle: getEl('records-title')
        };
        const editModal = getEl('edit-modal');
        const editForm = getEl('edit-form');
        const cancelEditBtn = getEl('cancel-edit-btn');
        const manageNamesModal = getEl('manage-names-modal');
        const manageNamesBtn = getEl('manage-names-btn');
        const closeManageNamesBtn = getEl('close-manage-names-btn');
        const manageNamesContent = getEl('manage-names-content');
        const historyModal = getEl('history-modal');
        const closeHistoryBtn = getEl('close-history-btn');
        const historyBtn = getEl('history-btn');
        const historyContentContainer = getEl('history-content-container');
        
        // --- SVG ICONS ---
        const trashIconSVG = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>`;
        const checkIconSVG = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>`;
        const editIconSVG = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg>`;
        const calendarIconSVG = `<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg>`;
        const noteIconSVG = `<svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"></path><path fill-rule="evenodd" d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>`;

        
        // --- UTILITY & FORMATTING FUNCTIONS ---
        const formatRupiah = amount => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
        const getTodayString = () => new Date().toISOString().slice(0, 10);
        const formatTimestamp = (isoString) => new Date(isoString).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short', hour12: false });
        const formatDate = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString);
            return new Date(date.getTime() + (date.getTimezoneOffset() * 60000)).toLocaleDateString('id-ID', {
                day: 'numeric', month: 'short', year: 'numeric'
            });
        };
        
        // --- CUSTOM MODAL FUNCTIONS ---
        const customAlert = { modal: getEl('custom-alert-modal'), title: getEl('custom-alert-title'), message: getEl('custom-alert-message'), okBtn: getEl('custom-alert-ok-btn')};
        const customConfirm = { modal: getEl('custom-confirm-modal'), title: getEl('custom-confirm-title'), message: getEl('custom-confirm-message'), okBtn: getEl('custom-confirm-ok-btn'), cancelBtn: getEl('custom-confirm-cancel-btn') };
        const customPrompt = { modal: getEl('custom-prompt-modal'), title: getEl('custom-prompt-title'), message: getEl('custom-prompt-message'), input: getEl('custom-prompt-input'), okBtn: getEl('custom-prompt-ok-btn'), cancelBtn: getEl('custom-prompt-cancel-btn') };

        const showAlert = (message, title = 'Peringatan') => {
            customAlert.title.textContent = title;
            customAlert.message.textContent = message;
            customAlert.modal.classList.remove('hidden');
            return new Promise(resolve => {
                customAlert.okBtn.onclick = () => {
                    customAlert.modal.classList.add('hidden');
                    resolve();
                };
            });
        };

        const showConfirm = (message, title = 'Konfirmasi') => {
            customConfirm.title.textContent = title;
            customConfirm.message.textContent = message;
            customConfirm.modal.classList.remove('hidden');
            return new Promise((resolve) => {
                const handleOk = () => { customConfirm.modal.classList.add('hidden'); resolve(true); removeListeners(); };
                const handleCancel = () => { customConfirm.modal.classList.add('hidden'); resolve(false); removeListeners(); };
                const removeListeners = () => {
                    customConfirm.okBtn.removeEventListener('click', handleOk);
                    customConfirm.cancelBtn.removeEventListener('click', handleCancel);
                };
                customConfirm.okBtn.addEventListener('click', handleOk);
                customConfirm.cancelBtn.addEventListener('click', handleCancel);
            });
        };
        const showPrompt = (message, defaultValue = '', title = 'Input Diperlukan') => {
            customPrompt.title.textContent = title;
            customPrompt.message.textContent = message;
            customPrompt.input.value = defaultValue;
            customPrompt.modal.classList.remove('hidden');
            customPrompt.input.focus();
            return new Promise((resolve) => {
                const handleOk = () => { customPrompt.modal.classList.add('hidden'); resolve(customPrompt.input.value); removeListeners(); };
                const handleCancel = () => { customPrompt.modal.classList.add('hidden'); resolve(null); removeListeners(); };
                const removeListeners = () => {
                    customPrompt.okBtn.removeEventListener('click', handleOk);
                    customPrompt.cancelBtn.removeEventListener('click', handleCancel);
                };
                customPrompt.okBtn.addEventListener('click', handleOk);
                customPrompt.cancelBtn.addEventListener('click', handleCancel);
            });
        };

        
        // --- AUTHENTICATION UI LOGIC ---
        function setAuthMode(register) {
            isRegisterMode = register;
            authTitle.textContent = register ? 'Daftar Akun Baru' : 'Masuk';
            authSubmitBtn.textContent = register ? 'Daftar' : 'Masuk';
            authSwitchText.textContent = register ? 'Sudah punya akun?' : 'Belum punya akun?';
            authSwitchBtn.textContent = register ? 'Masuk di sini' : 'Daftar di sini';
            authError.classList.add('hidden');
        }

        function showAuthError(message) {
            authError.textContent = message;
            authError.classList.remove('hidden');
        }

        // --- CORE APP LOGIC ---
        async function logAction(action, details, logType) {
            if (!db || !appId) return;
            const logUserId = auth.currentUser?.uid || 'system';
            try {
                 await addDoc(collection(db, `artifacts/${appId}/public/data/history`), {
                    userId: logUserId,
                    userEmail: auth.currentUser?.email || 'N/A',
                    action,
                    details,
                    logType,
                    timestamp: new Date().toISOString()
                });
            } catch (error) {
                console.error("Error logging action:", error);
            }
        }

        function createListItem(item) {
            const { id, type, name, amount, category, date, note, isPaid = false } = item;
            const itemDiv = document.createElement('div');
            const typeConfig = {
                income: { color: 'text-cyan-300', catBg: 'bg-cyan-500/20', catColor: 'text-cyan-400', label: 'Pendapatan' },
                expense: { color: 'text-red-300', catBg: 'bg-red-500/20', catColor: 'text-red-400', label: 'Pengeluaran' },
                savings: { color: 'text-green-300', label: 'Tabungan' },
                debt: { color: 'text-yellow-300', label: 'Hutang' },
                receivable: { color: 'text-blue-300', label: 'Piutang' }
            };
            const config = typeConfig[type];
            const categoryHTML = category ? `<span class="text-xs ${config.catBg} ${config.catColor} px-2 py-1 rounded-full">${category}</span>` : `<span class="text-xs bg-slate-600 text-slate-300 px-2 py-1 rounded-full">${config.label}</span>`;
            
            const noteHTML = note ? `<div class="flex items-center text-xs text-slate-400 mt-1.5">${noteIconSVG} <span class="italic">${note}</span></div>` : '';

            let actionButtons = `
                <button data-id="${id}" class="edit-btn text-slate-400 hover:text-white transition-colors mr-2">${editIconSVG}</button>
                <button data-id="${id}" class="delete-btn text-slate-400 hover:text-white transition-colors">${trashIconSVG}</button>`;
                
            if (type === 'debt' || type === 'receivable') {
                actionButtons = `
                    <button data-id="${id}" class="toggle-paid-btn text-slate-400 ${isPaid ? 'text-green-400' : 'hover:text-green-400'} transition-colors mr-2">
                        ${checkIconSVG}
                    </button>
                    ${actionButtons}
                `;
            }

            itemDiv.className = `bg-slate-700 p-3 rounded-lg flex justify-between items-center transition-opacity ${isPaid ? 'opacity-50' : ''}`;
            itemDiv.innerHTML = `
                <div class="flex flex-col flex-grow mr-2 overflow-hidden">
                    <span class="font-medium text-sm text-white truncate ${isPaid ? 'line-through' : ''}" title="${name}">${name}</span>
                    <div class="flex items-center text-xs text-slate-400 mt-1 flex-wrap">
                        ${calendarIconSVG}
                        <span>${formatDate(date)}</span>
                        <span class="mx-2">|</span>
                        ${categoryHTML}
                    </div>
                    ${noteHTML}
                </div>
                <div class="flex items-center flex-shrink-0">
                    <span class="font-semibold ${config.color} mr-4 ${isPaid ? 'line-through' : ''}">${formatRupiah(amount)}</span>
                    <div class="flex items-center">${actionButtons}</div>
                </div>`;
            return itemDiv;
        }

        function updateOverallSummary() {
            const totalIncome = allRecords.filter(r => r.type === 'income').reduce((sum, item) => sum + item.amount, 0);
            const totalExpenses = allRecords.filter(r => r.type === 'expense').reduce((sum, item) => sum + item.amount, 0);
            const totalSavings = allRecords.filter(r => r.type === 'savings').reduce((sum, item) => sum + item.amount, 0);
            const totalDebts = allRecords.filter(r => r.type === 'debt' && !r.isPaid).reduce((sum, item) => sum + item.amount, 0);
            const totalReceivables = allRecords.filter(r => r.type === 'receivable' && !r.isPaid).reduce((sum, item) => sum + item.amount, 0);
            const remainingBalance = totalIncome - totalExpenses;

            summaryElements.totalIncome.textContent = formatRupiah(totalIncome);
            summaryElements.totalExpenses.textContent = formatRupiah(totalExpenses);
            summaryElements.totalSavings.textContent = formatRupiah(totalSavings);
            summaryElements.totalDebts.textContent = formatRupiah(totalDebts);
            summaryElements.totalReceivables.textContent = formatRupiah(totalReceivables);
            
            const balanceEl = summaryElements.remainingBalance;
            balanceEl.textContent = formatRupiah(remainingBalance);
            balanceEl.className = 'text-xl font-bold ';
            if (remainingBalance >= 0) balanceEl.classList.add('text-green-400');
            else balanceEl.classList.add('text-red-400');
        }

        function populateDatalists() {
            Object.keys(savedNames).forEach(type => {
                const datalist = document.getElementById(`${type}-names`);
                if (datalist) {
                    datalist.innerHTML = '';
                    if (Array.isArray(savedNames[type])) {
                        savedNames[type].forEach(name => {
                            const option = document.createElement('option');
                            option.value = name;
                            datalist.appendChild(option);
                        });
                    }
                }
            });
        }
        
        function renderUI() {
            applyFilters();
            updateOverallSummary();
            populateDatalists();
        }

        function resetAppState() {
            allRecords = [];
            savedNames = { income: [], expense: [], savings: [], debt: [], receivable: [] };
            allHistory = [];
            editingRecordId = null;
            renderUI();
        }

        async function handleFormSubmit(event, type) {
            event.preventDefault();
            const form = event.target;
            const name = form.querySelector('[data-field="name"]').value.trim();
            const amount = parseFloat(form.querySelector('[data-field="amount"]').value);
            const date = form.querySelector('[data-field="date"]').value || getTodayString();
            const note = form.querySelector('[data-field="note"]').value.trim();
            const categoryEl = form.querySelector('[data-field="category"]');

            if (!name || !(amount > 0)) {
                return showAlert("Nama dan Jumlah harus diisi dengan benar.");
            }

            const currentNamesForType = savedNames[type] || [];
            if (!currentNamesForType.includes(name)) {
                const newSavedNames = { ...savedNames, [type]: [...currentNamesForType, name] };
                await setDoc(doc(db, `/artifacts/${appId}/users/${userId}/app_data/savedNames`), newSavedNames);
            }

            const newRecord = { type, name, amount, date, note, isPaid: false, createdAt: new Date().toISOString() };
            if (categoryEl) newRecord.category = categoryEl.value;
            
            try {
                await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/records`), newRecord);
                form.reset();
                form.querySelector('[data-field="date"]').value = getTodayString();
                logAction(`Tambah ${type}`, `${name} - ${formatRupiah(amount)}`, 'transaction');
                filterControls.resetBtn.click();
            } catch(error) {
                console.error("Error adding document: ", error);
                await showAlert("Gagal menyimpan transaksi ke database.");
            }
        }
        
        function applyFilters() {
            const typeFilter = filterControls.type.value;
            const startDate = filterControls.start.value;
            const endDate = filterControls.end.value;
            const category = filterControls.category.value;
            const nameFilter = filterControls.name.value.toLowerCase().trim();
            
            let displayRecords = allRecords.filter(record => {
                if (typeFilter !== 'semua' && record.type !== typeFilter) return false;
                if (startDate && record.date < startDate) return false;
                if (endDate && record.date > endDate) return false;
                if (nameFilter && !record.name.toLowerCase().includes(nameFilter)) return false;
                if ((record.type === 'expense' || record.type === 'income') && category !== 'semua' && record.category !== category) return false;
                return true;
            });
            
            allRecordsList.innerHTML = '';
            if(displayRecords.length === 0) {
                 allRecordsList.innerHTML = `<p class="text-slate-500 text-center italic">Tidak ada catatan yang cocok.</p>`;
            } else {
                 displayRecords.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(rec => allRecordsList.appendChild(createListItem(rec)));
            }
            
            const filteredIncome = displayRecords.filter(r => r.type === 'income').reduce((sum, i) => sum + i.amount, 0);
            const filteredExpenses = displayRecords.filter(r => r.type === 'expense').reduce((sum, i) => sum + i.amount, 0);
            const filteredSavings = displayRecords.filter(r => r.type === 'savings').reduce((sum, i) => sum + i.amount, 0);
            const filteredCashflow = filteredIncome - filteredExpenses;

            filterControls.filteredIncome.textContent = formatRupiah(filteredIncome);
            filterControls.filteredExpenses.textContent = formatRupiah(filteredExpenses);
            filterControls.filteredSavings.textContent = formatRupiah(filteredSavings);
            filterControls.filteredCashflow.textContent = formatRupiah(filteredCashflow);

            filterControls.filteredIncomeSummary.classList.toggle('hidden', filteredIncome === 0);
            filterControls.filteredExpensesSummary.classList.toggle('hidden', filteredExpenses === 0);
            filterControls.filteredSavingsSummary.classList.toggle('hidden', filteredSavings === 0);
            filterControls.filteredCashflowSummary.classList.toggle('hidden', filteredIncome === 0 && filteredExpenses === 0);
            
            const isFiltered = typeFilter !== 'semua' || startDate || endDate || nameFilter;
            filterControls.summaryContainer.classList.toggle('hidden', !isFiltered);
            filterControls.recordsTitle.textContent = isFiltered ? "Hasil Filter Transaksi" : "Semua Catatan Transaksi";
        }
        
        function updateFilterCategoryOptions() {
            const selectedType = filterControls.type.value;
            const categorySelect = filterControls.category;
            const categoryLabel = filterControls.categoryLabel;

            categorySelect.innerHTML = '<option value="semua">Semua Kategori</option>';
            
            if (selectedType === 'expense' || selectedType === 'income') {
                const sourceForm = forms[selectedType];
                const sourceOptions = sourceForm.querySelector('select').options;
                for (let option of sourceOptions) {
                    categorySelect.add(new Option(option.text, option.value));
                }
                categorySelect.disabled = false;
                categoryLabel.classList.remove('opacity-50');
            } else {
                categorySelect.disabled = true;
                categoryLabel.classList.add('opacity-50');
                categorySelect.value = 'semua';
            }
        }
        
        function openEditModal(id) {
            const record = allRecords.find(r => r.id === id);
            if (!record) return;

            editingRecordId = id;
            getEl('edit-name').value = record.name;
            getEl('edit-amount').value = record.amount;
            getEl('edit-date').value = record.date;
            getEl('edit-note').value = record.note || '';
            
            const categoryContainer = getEl('edit-category-container');
            const categorySelect = getEl('edit-category');

            if (record.type === 'income' || record.type === 'expense') {
                const sourceSelect = document.querySelector(`#${record.type}-form select`);
                categorySelect.innerHTML = sourceSelect.innerHTML;
                categorySelect.value = record.category;
                categoryContainer.classList.remove('hidden');
            } else {
                categoryContainer.classList.add('hidden');
            }
            editModal.classList.remove('hidden');
        }

        function openManageNamesModal() {
            manageNamesContent.innerHTML = '';
            const typeLabels = { income: 'Pendapatan', expense: 'Pengeluaran', savings: 'Tabungan', debt: 'Hutang', receivable: 'Piutang' };
            Object.keys(typeLabels).forEach(type => {
                const container = document.createElement('div');
                container.innerHTML = `<h4 class="text-lg font-bold text-slate-300 mb-2">${typeLabels[type]}</h4>`;
                const list = document.createElement('ul');
                list.className = 'space-y-2';
                const namesForType = savedNames[type] || [];
                if (namesForType.length === 0) {
                     let li = document.createElement('li');
                     li.className = 'text-slate-500 italic text-sm';
                     li.textContent = 'Belum ada nama tersimpan.';
                     list.appendChild(li);
                } else {
                    namesForType.forEach(name => {
                        const li = document.createElement('li');
                        li.className = 'flex items-center justify-between bg-slate-700 p-2 rounded-lg';
                        li.innerHTML = `
                            <span class="flex-grow truncate pr-2" title="${name}">${name}</span>
                            <div class="flex items-center flex-shrink-0">
                                <button data-type="${type}" data-name="${name}" class="edit-saved-name-btn text-slate-400 hover:text-white mr-2">${editIconSVG}</button>
                                <button data-type="${type}" data-name="${name}" class="delete-saved-name-btn text-slate-400 hover:text-white">${trashIconSVG}</button>
                            </div>
                        `;
                        list.appendChild(li);
                    });
                }
                container.appendChild(list);
                manageNamesContent.appendChild(container);
            });
            manageNamesModal.classList.remove('hidden');
        }

        function showHistoryModal() {
            const renderHistory = (container, historyList) => {
                container.innerHTML = '';
                if (!historyList || historyList.length === 0) {
                    container.innerHTML = '<p class="text-slate-500 text-center italic">Tidak ada histori untuk ditampilkan.</p>';
                } else {
                    const sortedHistory = [...historyList].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    sortedHistory.forEach(log => {
                        const logEl = document.createElement('div');
                        logEl.className = 'bg-slate-700/50 p-3 rounded-lg mb-2 text-sm';
                        logEl.innerHTML = `
                           <div class="flex justify-between items-center">
                             <span class="font-semibold text-indigo-300">${log.action}</span>
                             <span class="text-xs text-slate-400">${formatTimestamp(log.timestamp)}</span>
                           </div>
                           <p class="text-slate-300 mt-1">${log.details}</p>
                           <p class="text-xs text-slate-500 mt-1">User: ${log.userEmail || (log.userId ? log.userId.substring(0,8) : 'N/A')}</p>
                        `;
                        container.appendChild(logEl);
                    });
                }
            };
            
            const transactionActivities = allHistory.filter(log => log.logType === 'transaction');
            renderHistory(historyContentContainer, transactionActivities);
            historyModal.classList.remove('hidden');
        }

        async function handleEditSavedName(e) {
            const button = e.target.closest('button');
            const type = button.dataset.type;
            const oldName = button.dataset.name;
            const newName = (await showPrompt(`Edit nama "${oldName}":`, oldName, 'Edit Nama Tersimpan'))?.trim();
            if (!newName || newName === oldName) return;

            const currentNames = savedNames[type] || [];

            if (currentNames.includes(newName)) {
                const confirmed = await showConfirm(`Nama "${newName}" sudah ada. Apakah Anda ingin menggabungkan semua transaksi dari "${oldName}" ke "${newName}"?`, 'Konfirmasi Gabung Nama');
                if (confirmed) {
                    const batch = writeBatch(db);
                    const recordsToUpdateQuery = query(collection(db, `/artifacts/${appId}/users/${userId}/records`), where("type", "==", type), where("name", "==", oldName));
                    const querySnapshot = await getDocs(recordsToUpdateQuery);
                    querySnapshot.forEach((docToUpdate) => {
                        batch.update(doc(db, `/artifacts/${appId}/users/${userId}/records`, docToUpdate.id), { name: newName });
                    });
                    
                    const updatedNamesList = currentNames.filter(name => name !== oldName);
                    const namesRef = doc(db, `/artifacts/${appId}/users/${userId}/app_data/savedNames`);
                    batch.set(namesRef, { ...savedNames, [type]: updatedNamesList });
                    
                    await batch.commit();
                    logAction('Gabung Nama Tersimpan', `"${oldName}" -> "${newName}"`, 'transaction');
                }
            } else {
                const batch = writeBatch(db);
                const nameIndex = currentNames.indexOf(oldName);
                if (nameIndex > -1) {
                    currentNames[nameIndex] = newName;
                    
                    const recordsToUpdateQuery = query(collection(db, `/artifacts/${appId}/users/${userId}/records`), where("type", "==", type), where("name", "==", oldName));
                    const querySnapshot = await getDocs(recordsToUpdateQuery);
                    querySnapshot.forEach((docToUpdate) => {
                        batch.update(doc(db, `/artifacts/${appId}/users/${userId}/records`, docToUpdate.id), { name: newName });
                    });

                    const namesRef = doc(db, `/artifacts/${appId}/users/${userId}/app_data/savedNames`);
                    batch.set(namesRef, { ...savedNames, [type]: currentNames });
                    
                    await batch.commit();
                    logAction('Edit Nama Tersimpan', `"${oldName}" -> "${newName}"`, 'transaction');
                }
            }
        }


        async function handleDeleteSavedName(e) {
             const button = e.target.closest('button');
            const type = button.dataset.type;
            const nameToDelete = button.dataset.name;
            const isUsed = allRecords.some(record => record.type === type && record.name === nameToDelete);
            if (isUsed) {
                return showAlert(`Nama "${nameToDelete}" tidak bisa dihapus karena sedang digunakan dalam transaksi.`);
            }
            if (await showConfirm(`Anda yakin ingin menghapus nama "${nameToDelete}"?`, 'Konfirmasi Hapus')) {
                 const newNamesList = (savedNames[type] || []).filter(name => name !== nameToDelete);
                 await setDoc(doc(db, `/artifacts/${appId}/users/${userId}/app_data/savedNames`), { ...savedNames, [type]: newNamesList });
                 logAction('Hapus Nama Tersimpan', `"${nameToDelete}"`, 'transaction');
            }
        }

        // --- EVENT LISTENERS ---
        function addAllEventListeners() {
            authSwitchBtn.addEventListener('click', () => setAuthMode(!isRegisterMode));
            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = getEl('auth-email').value;
                const password = getEl('auth-password').value;
                authError.classList.add('hidden');
                try {
                    if (isRegisterMode) {
                        await createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (error) {
                    showAuthError("Gagal. Periksa kembali email dan password Anda.");
                }
            });
            googleSigninBtn.addEventListener('click', async () => {
                try {
                    await signInWithPopup(auth, new GoogleAuthProvider());
                } catch (error) {
                     showAuthError("Gagal masuk dengan Google. Silakan coba lagi.");
                }
            });
            logoutBtn.addEventListener('click', () => signOut(auth));
            
            Object.keys(forms).forEach(type => {
                forms[type].addEventListener('submit', (e) => handleFormSubmit(e, type));
            });
            
            filterControls.applyBtn.addEventListener('click', applyFilters);
            filterControls.resetBtn.addEventListener('click', () => {
                 filterControls.type.value = 'semua';
                 filterControls.start.value = '';
                 filterControls.end.value = '';
                 filterControls.name.value = '';
                 updateFilterCategoryOptions();
                 applyFilters();
            });
            filterControls.type.addEventListener('change', updateFilterCategoryOptions);
            
            allRecordsList.addEventListener('click', async (e) => {
                const button = e.target.closest('button');
                if (!button || !userId) return;
                const id = button.dataset.id;
                const record = allRecords.find(r => r.id === id);
                if (!record) return;
                
                const recordRef = doc(db, `/artifacts/${appId}/users/${userId}/records`, id);

                if (button.classList.contains('delete-btn')) {
                    if(await showConfirm(`Yakin ingin menghapus transaksi "${record.name}"?`, 'Konfirmasi Hapus')){
                        await deleteDoc(recordRef);
                        logAction(`Hapus ${record.type}`, `${record.name} - ${formatRupiah(record.amount)}`, 'transaction');
                    }
                } else if (button.classList.contains('toggle-paid-btn')) {
                    const newStatus = !record.isPaid;
                    await updateDoc(recordRef, { isPaid: newStatus });
                    const status = newStatus ? 'Lunas' : 'Belum Lunas';
                    logAction(`Ubah Status ${record.type}`, `${record.name} menjadi ${status}`, 'transaction');
                } else if (button.classList.contains('edit-btn')) {
                    openEditModal(id);
                }
            });

            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if(!editingRecordId) return;
                const record = allRecords.find(r => r.id === editingRecordId);
                if(!record) return;

                const updatedData = {
                    name: getEl('edit-name').value.trim(),
                    amount: parseFloat(getEl('edit-amount').value),
                    date: getEl('edit-date').value,
                    note: getEl('edit-note').value.trim()
                };
                if (!updatedData.name || !(updatedData.amount > 0)) return showAlert("Nama dan Jumlah harus diisi dengan benar.");
                
                const categorySelect = getEl('edit-category');
                 if (!categorySelect.parentElement.classList.contains('hidden')) {
                    updatedData.category = categorySelect.value;
                }

                const recordRef = doc(db, `/artifacts/${appId}/users/${userId}/records`, editingRecordId);
                await updateDoc(recordRef, updatedData);
                logAction(`Edit ${record.type}`, `"${record.name}" -> "${updatedData.name}"`, 'transaction');
                editModal.classList.add('hidden');
            });
            cancelEditBtn.addEventListener('click', () => editModal.classList.add('hidden'));

            manageNamesBtn.addEventListener('click', openManageNamesModal);
            closeManageNamesBtn.addEventListener('click', () => manageNamesModal.classList.add('hidden'));
            historyBtn.addEventListener('click', showHistoryModal);
            closeHistoryBtn.addEventListener('click', () => historyModal.classList.add('hidden'));
            
            manageNamesContent.addEventListener('click', (e) => {
                if (e.target.closest('.edit-saved-name-btn')) {
                    handleEditSavedName(e);
                }
                if (e.target.closest('.delete-saved-name-btn')) {
                    handleDeleteSavedName(e);
                }
            });
        }
        
        // --- FIREBASE INITIALIZATION & AUTH STATE MANAGEMENT ---
        function detachFirestoreListeners() {
            if (recordsUnsubscribe) recordsUnsubscribe();
            if (namesUnsubscribe) namesUnsubscribe();
            if (historyUnsubscribe) historyUnsubscribe();
            recordsUnsubscribe = namesUnsubscribe = historyUnsubscribe = null;
        }

        function attachFirestoreListeners() {
            if (!db || !userId) return;
            detachFirestoreListeners();

            const recordsPath = `/artifacts/${appId}/users/${userId}/records`;
            recordsUnsubscribe = onSnapshot(collection(db, recordsPath), (snapshot) => {
                allRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI();
            }, error => console.error("Records listener error:", error));

            const namesPath = `/artifacts/${appId}/users/${userId}/app_data/savedNames`;
            namesUnsubscribe = onSnapshot(doc(db, namesPath), (docSnap) => {
                if (docSnap.exists()) {
                    savedNames = docSnap.data();
                } else {
                    savedNames = { income: [], expense: [], savings: [], debt: [], receivable: [] };
                    setDoc(doc(db, namesPath), savedNames).catch(e => console.error("Error creating savedNames doc:", e));
                }
                populateDatalists();
            }, error => console.error("Saved names listener error:", error));
            
            const historyPath = `/artifacts/${appId}/public/data/history`;
            historyUnsubscribe = onSnapshot(query(collection(db, historyPath)), (snapshot) => {
                allHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }, error => console.error("History listener error:", error));
        }

        async function initializeAppFlow() {
             try {
                const firebaseConfig = {
                    apiKey: "AIzaSyCUOfdSPWN4avQsox-0RyxGWwS-c2oRLRo",
                    authDomain: "test-f0749.firebaseapp.com",
                    projectId: "test-f0749",
                    storageBucket: "test-f0749.firebasestorage.app",
                    messagingSenderId: "777827353315",
                    appId: "1:777827353315:web:b2647a210011f374ec3bd6"
                };

                appId = firebaseConfig.projectId;
                if (!appId) throw new Error("projectId tidak ditemukan di dalam firebaseConfig.");
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                addAllEventListeners();

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        currentUserDisplay.textContent = user.email || 'Pengguna Google';
                        if (user.metadata.creationTime === user.metadata.lastSignInTime) {
                             if(!user.email){
                                logAction('User Register', `Google User: ${user.uid.substring(0,8)}...`, 'auth');
                             } else {
                                logAction('User Register', `Email: ${user.email}`, 'auth');
                             }
                        } else {
                             if(!user.email){
                                logAction('User Login', `Google User: ${user.uid.substring(0,8)}...`, 'auth');
                             } else {
                                logAction('User Login', `Email: ${user.email}`, 'auth');
                             }
                        }
                        attachFirestoreListeners();
                        authScreen.classList.add('hidden');
                        appContainer.classList.remove('hidden');
                    } else {
                        userId = null;
                        detachFirestoreListeners();
                        resetAppState();
                        appContainer.classList.add('hidden');
                        authScreen.classList.remove('hidden');
                        setAuthMode(false);
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                authScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
                authScreen.innerHTML = `<div class="bg-slate-800 p-8 rounded-2xl shadow-2xl text-center">
                    <h2 class="text-2xl font-bold text-red-400 mb-4">Error Inisialisasi Kritis</h2>
                    <p class="text-slate-300">Gagal memuat konfigurasi aplikasi.</p>
                    <p class="text-xs text-slate-500 mt-4">Detail: ${error.message}</p>
                </div>`;
            }
        }
        
        // --- START THE APP ---
        initializeAppFlow();

    </script>
</body>
</html>
