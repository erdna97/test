<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Anggaran (Online & Kolaboratif)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="bg-slate-900 text-white flex items-center justify-center min-h-screen p-4">

    <!-- Layar Login / Registrasi -->
    <div id="auth-screen" class="w-full max-w-sm">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl">
            <h2 id="auth-title" class="text-3xl font-bold text-center text-cyan-400 mb-6">Masuk</h2>
            <p id="auth-error" class="bg-red-500/20 text-red-300 text-sm p-3 rounded-lg mb-4 text-center hidden"></p>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="auth-email" class="block text-slate-300 mb-1">Email</label>
                    <input type="email" id="auth-email" required class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-cyan-500 transition">
                </div>
                <div>
                    <label for="auth-password" class="block text-slate-300 mb-1">Password</label>
                    <input type="password" id="auth-password" required class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-cyan-500 transition">
                </div>
                <button type="submit" id="auth-submit-btn" class="w-full bg-cyan-500 hover:bg-cyan-600 font-semibold rounded-lg p-3 transition-colors !mt-6">Masuk</button>
            </form>
            <div class="relative my-6">
              <div class="absolute inset-0 flex items-center" aria-hidden="true">
                <div class="w-full border-t border-slate-600"></div>
              </div>
              <div class="relative flex justify-center text-sm">
                <span class="bg-slate-800 px-2 text-slate-400">Atau</span>
              </div>
            </div>
            <button id="google-signin-btn" class="w-full bg-slate-700 hover:bg-slate-600 font-semibold rounded-lg p-3 transition-colors flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="google" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 126 21.2 172.9 56.6l-67.4 66.8C314.6 95.8 282.5 80 248 80c-73.2 0-132.3 59.2-132.3 132S174.8 344 248 344c41.4 0 76.7-14.4 102.8-38.6l67.4 66.8C391.1 445.4 326.6 480 248 480c-119.3 0-216-96.7-216-216S128.7 40 248 40c74.4 0 134.3 26.1 179.4 69.8l-2.4 2.3C458.7 155.7 488 205.9 488 261.8z"></path></svg>
                Masuk dengan Google
            </button>
            <p class="text-center text-sm text-slate-400 mt-6">
                <span id="auth-switch-text">Belum punya akun?</span>
                <button id="auth-switch-btn" class="font-semibold text-cyan-400 hover:text-cyan-300">Daftar di sini</button>
            </p>
        </div>
    </div>

    <!-- Kontainer Aplikasi Utama (Hidden by default) -->
    <div id="app-container" class="w-full max-w-7xl hidden">
        <div class="bg-slate-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-8">
            <header class="text-center">
                <h1 class="text-3xl md:text-4xl font-bold text-cyan-400">Kalkulator Anggaran Lengkap</h1>
                <p class="text-slate-400 mt-2">Masuk sebagai: <span id="current-user-display" class="font-bold"></span></p>
                 <div class="mt-4 flex justify-center gap-4">
                    <button id="manage-names-btn" class="bg-gray-600 hover:bg-gray-700 font-semibold rounded-lg px-4 py-2 transition-colors text-sm">Kelola Nama</button>
                    <button id="history-btn" class="bg-indigo-600 hover:bg-indigo-700 font-semibold rounded-lg px-4 py-2 transition-colors text-sm">Lihat Histori</button>
                    <button id="logout-btn" class="bg-red-600 hover:bg-red-700 font-semibold rounded-lg px-4 py-2 transition-colors text-sm">Logout</button>
                </div>
            </header>

            <!-- Area Input -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Kolom Pendapatan -->
                <div class="space-y-4 bg-slate-900/50 p-6 rounded-xl">
                    <h2 class="text-2xl font-bold text-cyan-400">Input Pendapatan</h2>
                    <form id="income-form" class="space-y-2">
                        <input data-field="name" type="text" list="income-names" placeholder="Nama Pemasukan" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <datalist id="income-names"></datalist>
                        <input data-field="amount" type="number" placeholder="Jumlah" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <select data-field="category" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                            <option value="Gaji">Gaji</option>
                            <option value="Transfer">Transfer Masuk</option>
                            <option value="Bonus">Bonus</option>
                            <option value="Hasil Usaha">Hasil Usaha</option>
                            <option value="Lainnya">Lainnya</option>
                        </select>
                        <input data-field="date" type="date" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-slate-400">
                        <input data-field="note" type="text" placeholder="Catatan (opsional)" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 font-semibold rounded-lg px-4 py-2 transition-colors !mt-4">Tambah</button>
                    </form>
                </div>

                <!-- Kolom Pengeluaran -->
                <div class="space-y-4 bg-slate-900/50 p-6 rounded-xl">
                    <h2 class="text-2xl font-bold text-red-400">Input Pengeluaran</h2>
                    <form id="expense-form" class="space-y-2">
                        <input data-field="name" type="text" list="expense-names" placeholder="Nama Pengeluaran" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <datalist id="expense-names"></datalist>
                        <input data-field="amount" type="number" placeholder="Jumlah" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                         <select data-field="category" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                            <option value="Rumah">Kebutuhan Rumah</option>
                            <option value="Topup & Tagihan">Topup & Tagihan</option>
                            <option value="Jajan & Makanan">Jajan & Makanan</option>
                            <option value="Kendaraan">Kendaraan</option>
                            <option value="Transfer">Transfer Keluar</option>
                            <option value="Belanja">Belanja</option>
                            <option value="Kesehatan">Kesehatan</option>
                            <option value="Hiburan">Hiburan</option>
                            <option value="Pendidikan">Pendidikan</option>
                            <option value="Lainnya">Lainnya</option>
                        </select>
                        <input data-field="date" type="date" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-slate-400">
                        <input data-field="note" type="text" placeholder="Catatan (opsional)" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <button type="submit" class="w-full bg-red-500 hover:bg-red-600 font-semibold rounded-lg px-4 py-2 transition-colors !mt-4">Tambah</button>
                    </form>
                </div>

                <!-- Kolom Tabungan -->
                <div class="space-y-4 bg-slate-900/50 p-6 rounded-xl">
                    <h2 class="text-2xl font-bold text-green-400">Input Tabungan</h2>
                    <form id="savings-form" class="space-y-2">
                        <input data-field="name" type="text" list="savings-names" placeholder="Tujuan Tabungan" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <datalist id="savings-names"></datalist>
                        <input data-field="amount" type="number" placeholder="Jumlah" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <input data-field="date" type="date" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-slate-400">
                        <input data-field="note" type="text" placeholder="Catatan (opsional)" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <div class="h-[3.35rem]"></div> <!-- Spacer -->
                        <button type="submit" class="w-full bg-green-500 hover:bg-green-600 font-semibold rounded-lg px-4 py-2 transition-colors !mt-4">Tambah</button>
                    </form>
                </div>
                
                <!-- Kolom Hutang -->
                <div class="space-y-4 bg-slate-900/50 p-6 rounded-xl">
                    <h2 class="text-2xl font-bold text-yellow-400">Input Hutang</h2>
                    <form id="debt-form" class="space-y-2">
                        <input data-field="name" type="text" list="debt-names" placeholder="Deskripsi Hutang" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <datalist id="debt-names"></datalist>
                        <input data-field="amount" type="number" placeholder="Jumlah" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <input data-field="date" type="date" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-slate-400">
                        <input data-field="note" type="text" placeholder="Catatan (opsional)" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <div class="h-[3.35rem]"></div> <!-- Spacer -->
                        <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 font-semibold rounded-lg px-4 py-2 transition-colors !mt-4">Tambah</button>
                    </form>
                </div>

                <!-- Kolom Piutang -->
                <div class="space-y-4 bg-slate-900/50 p-6 rounded-xl">
                    <h2 class="text-2xl font-bold text-blue-400">Input Piutang</h2>
                    <form id="receivable-form" class="space-y-2">
                        <input data-field="name" type="text" list="receivable-names" placeholder="Deskripsi Piutang" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <datalist id="receivable-names"></datalist>
                        <input data-field="amount" type="number" placeholder="Jumlah" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <input data-field="date" type="date" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-slate-400">
                         <input data-field="note" type="text" placeholder="Catatan (opsional)" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        <div class="h-[3.35rem]"></div> <!-- Spacer -->
                        <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 font-semibold rounded-lg px-4 py-2 transition-colors !mt-4">Tambah</button>
                    </form>
                </div>
            </div>

            <div class="bg-slate-900/50 p-6 rounded-xl space-y-4">
                <h2 class="text-2xl font-bold text-white text-center">Evaluasi & Filter Transaksi</h2>
                <div id="filter-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4 items-end">
                    <!-- Filter controls remain the same -->
                    <div>
                        <label for="filter-type" class="block text-sm font-medium text-slate-300 mb-1">Tipe Transaksi</label>
                        <select id="filter-type" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                            <option value="semua">Semua Tipe</option>
                            <option value="income">Pendapatan</option>
                            <option value="expense">Pengeluaran</option>
                            <option value="savings">Tabungan</option>
                            <option value="debt">Hutang</option>
                            <option value="receivable">Piutang</option>
                        </select>
                    </div>
                    <div>
                        <label for="filter-start-date" class="block text-sm font-medium text-slate-300 mb-1">Dari Tanggal</label>
                        <input type="date" id="filter-start-date" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-slate-400">
                    </div>
                    <div>
                        <label for="filter-end-date" class="block text-sm font-medium text-slate-300 mb-1">Sampai Tanggal</label>
                        <input type="date" id="filter-end-date" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-slate-400">
                    </div>
                     <div>
                        <label for="filter-name" class="block text-sm font-medium text-slate-300 mb-1">Cari Nama</label>
                        <input type="text" id="filter-name" placeholder="cth: Listrik" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                    </div>
                    <div>
                        <label id="filter-category-label" for="filter-category" class="block text-sm font-medium text-slate-300 mb-1">Kategori</label>
                        <select id="filter-category" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2">
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <button id="apply-filter-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 font-semibold rounded-lg px-4 py-2 transition-colors">Terapkan</button>
                        <button id="reset-filter-btn" class="w-full bg-slate-600 hover:bg-slate-700 font-semibold rounded-lg px-4 py-2 transition-colors">Reset</button>
                    </div>
                </div>
                <div id="filtered-summary-container" class="pt-4 hidden">
                     <h4 class="text-lg font-semibold text-center text-indigo-300 mb-2">Ringkasan Hasil Filter</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-center p-4 bg-slate-800/50 rounded-lg">
                        <div id="filtered-income-summary" class="hidden"><p class="text-slate-400 text-xs">Pendapatan</p><p id="filtered-income" class="text-lg font-semibold text-cyan-400">Rp 0</p></div>
                        <div id="filtered-expenses-summary" class="hidden"><p class="text-slate-400 text-xs">Pengeluaran</p><p id="filtered-expenses" class="text-lg font-semibold text-red-400">Rp 0</p></div>
                        <div id="filtered-savings-summary" class="hidden"><p class="text-slate-400 text-xs">Tabungan</p><p id="filtered-savings" class="text-lg font-semibold text-green-400">Rp 0</p></div>
                        <div id="filtered-cashflow-summary" class="hidden"><p class="text-slate-400 text-xs">Arus Kas</p><p id="filtered-cashflow" class="text-lg font-bold text-white">Rp 0</p></div>
                    </div>
                </div>
            </div>

            <div class="bg-slate-900/50 p-6 rounded-xl">
                <h2 id="records-title" class="text-2xl font-bold text-white text-center mb-4">Semua Catatan Transaksi</h2>
                <div id="all-records-list" class="space-y-2 max-h-96 overflow-y-auto pr-2 custom-scrollbar"></div>
            </div>
            
            <footer class="bg-slate-900/70 p-6 rounded-xl mt-6">
                <h3 class="text-2xl font-bold text-center text-cyan-300 mb-4">Ringkasan Keuangan Total</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-center">
                    <div><p class="text-slate-400 text-sm">Total Pendapatan</p><p id="total-income" class="text-xl font-semibold text-cyan-400">Rp 0</p></div>
                    <div><p class="text-slate-400 text-sm">Total Pengeluaran</p><p id="total-expenses" class="text-xl font-semibold text-red-400">Rp 0</p></div>
                    <div><p class="text-slate-400 text-sm">Total Tabungan</p><p id="total-savings" class="text-xl font-semibold text-green-400">Rp 0</p></div>
                    <div><p class="text-slate-400 text-sm">Hutang Aktif</p><p id="total-debts" class="text-xl font-semibold text-yellow-400">Rp 0</p></div>
                    <div><p class="text-slate-400 text-sm">Piutang Aktif</p><p id="total-receivables" class="text-xl font-semibold text-blue-400">Rp 0</p></div>
                    <div><p class="text-slate-400 text-sm font-bold">Sisa Uang</p><p id="remaining-balance" class="text-xl font-bold text-white">Rp 0</p></div>
                </div>
            </footer>
        </div>
    </div>

    <!-- Modals (Edit, Manage Names, History, Custom) remain the same -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden"><!-- ... modal content ... --></div>
    <div id="manage-names-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden"><!-- ... modal content ... --></div>
    <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden"><!-- ... modal content ... --></div>
    <div id="custom-alert-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden"><!-- ... modal content ... --></div>
    <div id="custom-confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden"><!-- ... modal content ... --></div>
    <div id="custom-prompt-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden"><!-- ... modal content ... --></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL APP STATE ---
        let db, auth;
        let appId, userId;
        let allRecords = [], allHistory = [], savedNames = {};
        let editingRecordId = null;
        let recordsUnsubscribe, namesUnsubscribe, historyUnsubscribe;
        let isRegisterMode = false;

        // --- DOM ELEMENT SELECTION ---
        const getEl = id => document.getElementById(id);
        const authScreen = getEl('auth-screen');
        const appContainer = getEl('app-container');
        const authForm = getEl('auth-form');
        const authTitle = getEl('auth-title');
        const authError = getEl('auth-error');
        const authSubmitBtn = getEl('auth-submit-btn');
        const authSwitchBtn = getEl('auth-switch-btn');
        const authSwitchText = getEl('auth-switch-text');
        const googleSigninBtn = getEl('google-signin-btn');
        const logoutBtn = getEl('logout-btn');
        const currentUserDisplay = getEl('current-user-display');
        
        // Other DOM elements... (forms, lists, etc.)
        const forms = {
            income: getEl('income-form'), expense: getEl('expense-form'), savings: getEl('savings-form'), debt: getEl('debt-form'), receivable: getEl('receivable-form'),
        };
        const allRecordsList = getEl('all-records-list');

        // --- UTILITY & FORMATTING FUNCTIONS ---
        const formatRupiah = amount => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
        const getTodayString = () => new Date().toISOString().slice(0, 10);
        
        // --- AUTHENTICATION UI LOGIC ---
        function setAuthMode(register) {
            isRegisterMode = register;
            authTitle.textContent = register ? 'Daftar Akun Baru' : 'Masuk';
            authSubmitBtn.textContent = register ? 'Daftar' : 'Masuk';
            authSwitchText.textContent = register ? 'Sudah punya akun?' : 'Belum punya akun?';
            authSwitchBtn.textContent = register ? 'Masuk di sini' : 'Daftar di sini';
            authError.classList.add('hidden');
        }

        function showAuthError(message) {
            authError.textContent = message;
            authError.classList.remove('hidden');
        }

        authSwitchBtn.addEventListener('click', () => setAuthMode(!isRegisterMode));
        
        // --- AUTHENTICATION ACTIONS ---
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = getEl('auth-email').value;
            const password = getEl('auth-password').value;
            authError.classList.add('hidden');

            try {
                if (isRegisterMode) {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
                // onAuthStateChanged will handle the UI switch
            } catch (error) {
                console.error("Auth Error:", error.code, error.message);
                showAuthError("Gagal. Periksa kembali email dan password Anda.");
            }
        });
        
        googleSigninBtn.addEventListener('click', async () => {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                // onAuthStateChanged will handle the UI switch
            } catch (error) {
                 console.error("Google Sign-in Error:", error);
                 showAuthError("Gagal masuk dengan Google. Silakan coba lagi.");
            }
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });
        
        // --- CORE APP LOGIC (CRUD, Summaries, etc.) ---
        // (Most of the app's internal logic like createListItem, updateOverallSummary, handleFormSubmit, etc. remains largely the same)
        // A key change is ensuring `userId` is used in all Firestore paths.
        
        async function logAction(action, details) {
            if (!db || !appId) return; // Note: log can happen even if userId is not present (e.g. login attempt)
            const logUserId = auth.currentUser?.uid || 'system';
            try {
                 await addDoc(collection(db, `/artifacts/${appId}/public/data/history`), {
                    userId: logUserId,
                    action,
                    details,
                    timestamp: new Date().toISOString()
                });
            } catch (error) {
                console.error("Error logging action:", error);
            }
        }
        
        async function handleFormSubmit(event, type) {
            event.preventDefault();
            // ... (form data extraction)
            const form = event.target;
            const name = form.querySelector('[data-field="name"]').value.trim();
            const amount = parseFloat(form.querySelector('[data-field="amount"]').value);
            const date = form.querySelector('[data-field="date"]').value || getTodayString();
            const note = form.querySelector('[data-field="note"]').value.trim();
            const categoryEl = form.querySelector('[data-field="category"]');

            if (name && amount > 0) {
                 if (!savedNames[type]?.includes(name)) {
                     const currentNames = savedNames[type] || [];
                    const newSavedNames = { ...savedNames, [type]: [...currentNames, name] };
                    await setDoc(doc(db, `/artifacts/${appId}/users/${userId}/app_data/savedNames`), newSavedNames);
                }

                const newRecord = { type, name, amount, date, note, isPaid: false, createdAt: new Date().toISOString() };
                if (categoryEl) newRecord.category = categoryEl.value;
                
                try {
                    await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/records`), newRecord);
                    form.reset();
                    form.querySelector('[data-field="date"]').value = getTodayString();
                    logAction(`Tambah ${type}`, `${name} - ${formatRupiah(amount)}`);
                } catch(error) {
                    console.error("Error adding document: ", error);
                    // Use a custom alert if available
                }
            }
        }


        // --- FIREBASE INITIALIZATION & AUTH STATE MANAGEMENT ---
        function detachFirestoreListeners() {
            if (recordsUnsubscribe) recordsUnsubscribe();
            if (namesUnsubscribe) namesUnsubscribe();
            if (historyUnsubscribe) historyUnsubscribe();
            recordsUnsubscribe = namesUnsubscribe = historyUnsubscribe = null;
        }

        function attachFirestoreListeners() {
            if (!db || !userId) return;

            detachFirestoreListeners(); // Ensure no lingering listeners

            const recordsPath = `/artifacts/${appId}/users/${userId}/records`;
            recordsUnsubscribe = onSnapshot(collection(db, recordsPath), (snapshot) => {
                allRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Re-render UI with new data
                // This will be expanded with your app's rendering functions
                allRecordsList.innerHTML = '';
                 allRecords.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(rec => allRecordsList.appendChild(createListItem(rec)));
            }, error => console.error("Records listener error:", error));

            const namesPath = `/artifacts/${appId}/users/${userId}/app_data/savedNames`;
            namesUnsubscribe = onSnapshot(doc(db, namesPath), (docSnap) => {
                if (docSnap.exists()) {
                    savedNames = docSnap.data();
                } else {
                    savedNames = { income: [], expense: [], savings: [], debt: [], receivable: [] };
                    setDoc(doc(db, namesPath), savedNames);
                }
                // Update datalists
            }, error => console.error("Saved names listener error:", error));

            const historyPath = `/artifacts/${appId}/public/data/history`;
            historyUnsubscribe = onSnapshot(collection(db, historyPath), (snapshot) => {
                allHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }, error => console.error("History listener error:", error));
        }

        async function initializeAppFlow() {
             try {
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(__firebase_config);
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // USER IS LOGGED IN
                        userId = user.uid;
                        currentUserDisplay.textContent = user.email || 'Pengguna Google';
                        
                        attachFirestoreListeners();
                        
                        authScreen.classList.add('hidden');
                        appContainer.classList.remove('hidden');
                        
                    } else {
                        // USER IS LOGGED OUT
                        userId = null;
                        detachFirestoreListeners();

                        // Reset app state
                        allRecords = [];
                        savedNames = {};
                        // renderAll(); // a function to clear the UI
                        
                        appContainer.classList.add('hidden');
                        authScreen.classList.remove('hidden');
                        setAuthMode(false); // Default to login mode
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                authScreen.innerHTML = '<div class="text-center text-red-400">Gagal menginisialisasi aplikasi. Silakan segarkan halaman.</div>';
            }
        }
        
        // --- START THE APP ---
        initializeAppFlow();
        // Dummy function for placeholder
        function createListItem(item) {
            const div = document.createElement('div');
            div.className = 'bg-slate-700 p-2 rounded';
            div.textContent = `${item.name}: ${formatRupiah(item.amount)}`;
            return div;
        }
        // Add all other event listeners and functions from the previous version here
        Object.keys(forms).forEach(type => {
            forms[type].addEventListener('submit', (e) => handleFormSubmit(e, type));
        });


    </script>
</body>
</html>
